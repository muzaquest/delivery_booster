# ะะฝะฐะปะธัะธะบะฐ ะฟัะพะดะฐะถ ัะตััะพัะฐะฝะพะฒ (FastAPI + PostgreSQL + ETL + ML)

ะะพะดัะปัะฝะฐั ัะธััะตะผะฐ ะฐะฝะฐะปะธัะธะบะธ ะธ ะฟัะพะณะฝะพะทะฐ ะฟัะพะดะฐะถ ั FastAPI, PostgreSQL, ETL, ะธ ML (LightGBM/RandomForest + SHAP).

## ะัััััะน ััะฐัั (ะปะพะบะฐะปัะฝะพ)

ะขัะตะฑะพะฒะฐะฝะธั: Python 3.11+

1) ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
pip install -r requirements.txt
```

3) ะะฐะฟััะบ API

```bash
uvicorn app.main:app --reload
```

4) Streamlit UI (3 ะฒะบะปะฐะดะบะธ)

```bash
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

ะะบะปะฐะดะบะธ:
- **ะะฝะฐะปะธะท ัะตััะพัะฐะฝะฐ**: ะฒัะฑะพั ัะตััะพัะฐะฝะฐ ะธ ะฟะตัะธะพะดะฐ, ะณะตะฝะตัะฐัะธั ะฟะพะปะฝะพะณะพ ะพััััะฐ (1โ9), ัะพััะฐะฝะตะฝะธะต ะฒ `reports/` ะธ ัะบะฐัะธะฒะฐะฝะธะต `.md`.
- **ะะฝะฐะปะธะท ะฑะฐะทั**: KPIโะฟะฐะฝะตะปั (Sales, Orders, AOV, ROAS, MER, Cancels) ะธ MoM ััะฐะฒะฝะตะฝะธะต.
- **๐ค AI ะะฝะฐะปะธัะธะบ ะฟัะพะดะฐะถ**: ัะผะฝัะต ะพัะฒะตัั ะฝะฐ ะฒะพะฟัะพัั ัะธะฟะฐ "ะะพัะตะผั ัะฟะฐะปะธ ะฟัะพะดะฐะถะธ ะฒ ัะตััะพัะฐะฝะต X ะฒ ะฟะตัะธะพะด Y?" ั ML ะฐะฝะฐะปะธะทะพะผ ะฟัะธัะธะฝ.

5) ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (ะธะปะธ `DATABASE_URL`):

- `POSTGRES_HOST` (ะฟะพ ัะผะพะปัะฐะฝะธั: localhost)
- `POSTGRES_PORT` (ะฟะพ ัะผะพะปัะฐะฝะธั: 5432)
- `POSTGRES_DB` (ะฟะพ ัะผะพะปัะฐะฝะธั: analytics)
- `POSTGRES_USER` (ะฟะพ ัะผะพะปัะฐะฝะธั: postgres)
- `POSTGRES_PASSWORD` (ะฟะพ ัะผะพะปัะฐะฝะธั: postgres)

ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั:

```bash
python db/init_db.py
```

## ETL

- SQLite-ะธััะพัะฝะธะบ: ะฟะตัะตะผะตะฝะฝะฐั `SQLITE_PATH` (ะฟะพ ัะผะพะปัะฐะฝะธั `$PROJECT_ROOT/database.sqlite`)
- ะขััะฟะพัะพะบ (Excel): ััะฐะฝะธัะต ัะฐะนะปั ะฒ ัะตะฟะพะทะธัะพัะธะธ ะธ ะฟะตัะตะดะฐะฒะฐะนัะต ะฟััะธ ัะตัะตะท CLI/ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั; ะฟัะธะผะตัั: `$PROJECT_ROOT/1.-Data-Kunjungan-2025-3.xls`, `$PROJECT_ROOT/Table-1-7-Final-1-1.xls`.
- Fake orders: ัะฐะนะป `$PROJECT_ROOT/Fake orders` ัะพะดะตัะถะธั Google Sheet ัััะปะบั; ะปะธะฑะพ ะฟะตัะตะดะฐะนัะต `--fake-orders-sheet`.

ะกะฑะพัะบะฐ ะพะฑัะตะดะธะฝัะฝะฝะพะณะพ ะดะฐัะฐัะตัะฐ:

```bash
export PROJECT_ROOT=$PWD
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out "$PROJECT_ROOT/data/merged_dataset.csv" \
  --excel "$PROJECT_ROOT/1.-Data-Kunjungan-2025-3.xls" "$PROJECT_ROOT/Table-1-7-Final-1-1.xls"
```

## ะะฑััะตะฝะธะต ML-ะผะพะดะตะปะธ ะธ ะพะฑัััะฝะธะผะพััั (SHAP)

```bash
export PROJECT_ROOT=$PWD
python ml/training.py --csv "$PROJECT_ROOT/data/merged_dataset.csv" --out "$PROJECT_ROOT/ml/artifacts"
```

- ะะพะดะตะปะธ: LightGBM ะธ RandomForest (ะฒัะฑะธัะฐะตะผ ัะตะผะฟะธะพะฝะฐ ะฟะพ MAE)
- ะััะตัะฐะบัั: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`
- ะะตััะธั ะดะฐัะฐัะตัะฐ: `metrics.json` ัะพะดะตัะถะธั ััั, ัะฐะทะผะตั ะธ ะฒัะตะผั ะพะฑััะตะฝะธั; ะฒ ะพััััะต ะฟะตัะฐัะฐะตััั ะบัะฐัะบะฐั ะฒะตััะธั.

## API (ะฟะพัะปะต ETL ะธ ะพะฑััะตะฝะธั)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` โ ัะฒะพะดะบะฐ: ัะฐะบั/ะฟัะพะณะฝะพะท, AOV, ะขะะโัะฐะบัะพัั (SHAP)
- `GET /factors?period=...&restaurant_id=...` โ ัะฟะธัะพะบ ัะฐะบัะพัะพะฒ ั ะฒะปะธัะฝะธะตะผ ะฒ % (SHAP)
- `GET /report-text?period=...&restaurant_id=...` โ ะฟะพะปะฝัะน ัะตะบััะพะฒัะน ะพัััั ะฝะฐ ััััะบะพะผ (ัะพ ะฒัะตะผะธ ัะฐะทะดะตะปะฐะผะธ ะธ ML)

## ะขะตััั

```bash
pytest -q
```
- Smokeโัะตัั API: `/health`
- ะกะฝะฐะฟัะพัโัะตัั ะพััััะฐ: ะฟัะพะฒะตััะตั ะฝะฐะปะธัะธะต ัะฐะทะดะตะปะพะฒ 1โ9 ะดะปั ะพะดะฝะพะณะพ ัะตััะพัะฐะฝะฐ/ะฟะตัะธะพะดะฐ

## ะะฐะทะฒััััะฒะฐะฝะธะต ะฝะฐ Replit

1) ะะผะฟะพััะธััะนัะต ัะตะฟะพะทะธัะพัะธะน ะฒ Replit.
2) ะ Secrets (Environment) ะทะฐะดะฐะนัะต ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ:
   - `GOOGLE_API_KEY` โ ะดะปั Google Sheets ั ัะตะนะบะพะฒัะผะธ ะทะฐะบะฐะทะฐะผะธ
   - `SQLITE_PATH` โ ะฟััั ะบ SQLite (ะฟะพ ัะผะพะปัะฐะฝะธั `$PROJECT_ROOT/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` โ ะตัะปะธ ะธัะฟะพะปัะทัะตัะต ะฒะฝะตัะฝัั PostgreSQL
3) ะะตัะฒัะน ะทะฐะฟััะบ: ะฒัะฟะพะปะฝะธัะต ETL ะธ ะพะฑััะตะฝะธะต, ะทะฐัะตะผ ััะฐัั ัะตัะฒะตัะฐ ะธ UI:

```bash
export PROJECT_ROOT=$PWD
export SQLITE_PATH=$PWD/database.sqlite
export ML_ARTIFACT_DIR=$PWD/ml/artifacts
export ML_DATASET_CSV=$PWD/data/merged_dataset.csv
python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out "$ML_DATASET_CSV"
python ml/training.py --csv "$ML_DATASET_CSV" --out "$ML_ARTIFACT_DIR"
uvicorn app.main:app --host 0.0.0.0 --port 8000 &
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

## ะัะธะผะตัะฐะฝะธั ัะตััะฝะพััะธ ะดะฐะฝะฝัั
- ะคะตะนะบะพะฒัะต ะทะฐะบะฐะทั ะฒััะธัะฐัััั ะธะท ะทะฐะบะฐะทะพะฒ ะธ ะฒััััะบะธ
- ะะพะณะพะดะฐ โ OpenโMeteo ะฟะพ ะบะพะพัะดะธะฝะฐัะฐะผ ัะตััะพัะฐะฝะพะฒ (ะบะตั ะฒ SQLite; ัะพะปะฑัะบ ะฟะพ ะณะตะพะบะพะดะธะฝะณั)
- ะัะฐะทะดะฝะธะบะธ โ Nager.Date + ะปะพะบะฐะปัะฝัะต ะฑะฐะปะธะนัะบะธะต (ัะบัะตะนะฟะธะฝะณ 2024/2025; ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ ะธััะพัะฝะธะบะฐ โ ะบะตั)
- ะขััะธััะธัะตัะบะธะน ะฟะพัะพะบ โ ะธะท ะฟัะตะดะพััะฐะฒะปะตะฝะฝัั Excel
- ะะพะดะตะปั ะพะฑััะฐะตััั ะฝะฐ ะฒััะผ ะฟะตัะธะพะดะต (2.5 ะณะพะดะฐ), ัะฐะบัะพัั โ SHAP; ััะธะฒะธะฐะปัะฝัะต ะฟัะธะทะฝะฐะบะธ ะธัะบะปััะตะฝั ะธะท ะพะฑัััะฝะตะฝะธะน

## ะัะธะผะตั ะฟะพะปะฝะพะณะพ ะพััััะฐ (Prana, ะธัะปั 2025)

ะะธะถะต ะฟัะธะฒะตะดัะฝ ัะตะฐะปัะฝัะน ะฐะฝะฐะปะธะท ะฝะฐ ะพัะฝะพะฒะต API ะดะฐะฝะฝัั `/api/v1/getRestaurantStats?restaurant_name=Prana&source=grab&start_date=2025-07-01&end_date=2025-07-31`:

```
๐ 1. ะะกะะะะะะขะะะฌะะะ ะะะะฎะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ะะฑัะฐั ะฒััััะบะฐ: 557,391,932 IDR (GRAB: 312,455,000 IDR + GOJEK: 244,936,932 IDR)
๐ฆ ะะฑัะธะต ะทะฐะบะฐะทั: 2,375
   โโโ ๐ฑ GRAB: 1,245 ะทะฐะบะฐะทะพะฒ
   โโโ ๐ต GOJEK: 1,130 ะทะฐะบะฐะทะพะฒ
๐ต ะกัะตะดะฝะธะน ัะตะบ: ะพะฑัะธะน 234,691 IDR; GRAB 250,968 IDR; GOJEK 216,758 IDR
๐ ะะฝะตะฒะฝะฐั ะฒััััะบะฐ: 17,980,385 IDR (ััะตะดะฝัั ะทะฐ 31 ะดะตะฝั)
โญ ะกัะตะดะฝะธะน ัะตะนัะธะฝะณ: 4.75/5.0
๐ธ ะะฐัะบะตัะธะฝะณะพะฒัะน ะฑัะดะถะตั: 22,128,695 IDR (4.0% ะพั ะฒััััะบะธ)

๐ฏ ROAS ะะะะะะ:
โโโ ๐ฑ GRAB: 13.43x
โโโ ๐ต GOJEK: 50.65x
โโโ ๐ฏ ะะะฉะะ: 18.59x

๐ 2. ะะะะะะ ะะะะะะ ะ ะขะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะัััะธะน ะดะตะฝั GRAB: 2025-07-28 - 13,606,000 IDR
   โญ ะะตะนัะธะฝะณ: 4.70
   ๐ฆ ะะฐะบะฐะทะพะฒ: 52
๐ ะัััะธะน ะดะตะฝั GOJEK: 2025-07-02 - 12,124,998 IDR
   โญ ะะตะนัะธะฝะณ: N/A
   ๐ฆ ะะฐะบะฐะทะพะฒ: 47

๐ 4. ะะะะะะขะะะะะะะฏ ะญะคะคะะะขะะะะะกะขะฌ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะตะบะปะฐะผะฝะฐั ัััะตะบัะธะฒะฝะพััั ะทะฐ ะธัะปั 2025:
  ๐ฑ GRAB: ะฟะพััะฐัะธะปะธ 19,060,471 IDR โ ะฟะพะปััะธะปะธ 255,952,000 IDR
  ๐ต GOJEK: ะฟะพััะฐัะธะปะธ 3,068,224 IDR โ ะฟะพะปััะธะปะธ 155,419,950 IDR
  ๐ ะะพะปั ัะตะบะปะฐะผะฝัั ะฟัะพะดะฐะถ: GRAB 81.9%, GOJEK 63.5%

๐ง 5. ะะะะะะฆะะะะะะฏ ะญะคะคะะะขะะะะะกะขะฌ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โฑ๏ธ ะกัะตะดะฝะตะต ะฒัะตะผั ะพะถะธะดะฐะฝะธั ะฒะพะดะธัะตะปั (GRAB): 451.1 ัะตะบ
๐ด ะกัะตะดะฝะธะน offline rate (GRAB): 0.00%

๐ 6. ะะะะะะะะ ะะ ะะะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ GRAB ะฟะพ ะฝะตะดะตะปัะผ:
  1-7 ะธัะปั: 80,789,000 IDR
  8-14 ะธัะปั: 67,263,000 IDR
  15-21 ะธัะปั: 62,886,000 IDR
  22-28 ะธัะปั: 68,528,000 IDR
```

ะัะธะผะตั ะดะตะผะพะฝัััะธััะตั:
- ๐ ะะพะปะฝัั ะฐะฝะฐะปะธัะธะบั ะฟัะพะดะฐะถ ะฟะพ ะฟะปะฐััะพัะผะฐะผ GRAB/GOJEK
- ๐ฐ ะคะธะฝะฐะฝัะพะฒัะต ะผะตััะธะบะธ ั ROAS ะฐะฝะฐะปะธะทะพะผ  
- ๐ ะะธะฝะฐะผะธะบั ะฟัะพะดะฐะถ ะฟะพ ะฟะตัะธะพะดะฐะผ
- ๐ง ะะฟะตัะฐัะธะพะฝะฝัะต ะฟะพะบะฐะทะฐัะตะปะธ
- ๐ฏ ะัะฝะพะฒะฐะฝะฝัะต ะฝะฐ ะดะฐะฝะฝัั ัะตะบะพะผะตะฝะดะฐัะธะธ

ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะฐะฝะฐะปะธะทั ะปัะฑะพะณะพ ัะตััะพัะฐะฝะฐ ะทะฐ ะปัะฑะพะน ะฟะตัะธะพะด ัะตัะตะท API ะธะปะธ Streamlit ะธะฝัะตััะตะนั.

## ๐ค AI ะะฝะฐะปะธัะธะบ ะฟัะพะดะฐะถ (3-ั ะฒะบะปะฐะดะบะฐ)

ะฃะผะฝะฐั ัะธััะตะผะฐ ะพัะฒะตัะฐะตั ะฝะฐ ะณะปะฐะฒะฝัะต ะฒะพะฟัะพัั ะฒะปะฐะดะตะปััะตะฒ ัะตััะพัะฐะฝะพะฒ ัะตะปะพะฒะตัะตัะบะธะผ ะผะฐัะบะตัะธะฝะณะพะฒัะผ ัะทัะบะพะผ:

### ๐ ะัะธะผะตัั ะฒะพะฟัะพัะพะฒ:
- **"ะะพัะตะผั ัะฟะฐะปะธ ะฟัะพะดะฐะถะธ ะฒ Only Eggs ะฒ ะผะฐะต 2025?"**
- **"ะะพัะตะผั ะฟะฐะดะฐัั ะฟัะพะดะฐะถะธ ะฒ Ika Canggu ะฟะพัะปะตะดะฝะธะต 2 ะผะตัััะฐ?"**
- **"ะงัะพ ะฟัะพะธััะพะดะธั ั ะฟัะพะดะฐะถะฐะผะธ ะฒ Huge ะฒ ะธัะปะต?"**

### ๐ฏ ะงัะพ ัะผะตะตั AI:
- **ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั ัะตััะพัะฐะฝ** ะธะท ะดะพัััะฟะฝะพะณะพ ัะฟะธัะบะฐ
- **ะะฐัะฟะพะทะฝะฐะตั ะฟะตัะธะพะด:** "ะฒ ะผะฐะต 2025", "ะฟะพัะปะตะดะฝะธะต 2 ะผะตัััะฐ", "ะฒ ะธัะปะต"  
- **ML ะฐะฝะฐะปะธะท ะฟัะธัะธะฝ** ั SHAP ะพะฑัััะฝะตะฝะธัะผะธ
- **ะะตัะตะฒะพะดะธั ะฒ ะฑะธะทะฝะตั-ัะทัะบ:** "ััะตะทะฐะฝะธะต ัะตะบะปะฐะผะฝะพะณะพ ะฑัะดะถะตัะฐ GRAB ะฝะฐ 35%" ะฒะผะตััะพ "feature_importance=-0.35"
- **ะะพะฝะบัะตัะฝัะต ััะผะผั ะฟะพัะตัั** ะฒ IDR ะธ ะฟัะพัะตะฝัะฐั
- **ะัะธะพัะธัะตัั ะดะตะนััะฒะธะน** ๐ด๐ก๐ข ะฟะพ ะฒะฐะถะฝะพััะธ

### ๐ก ะัะธะผะตั ะพัะฒะตัะฐ AI:
```
๐ ะะะะะะ ะะะะะะะฏ ะะะะะะ: ONLY EGGS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ด ะกะะะซะ ะะะะขะะงะะกะะะ ะะะะฌ: 2025-05-15
โข ะัะพะดะฐะถะธ: 8.4M IDR (ะผะตะดะธะฐะฝะฐ: 13.8M IDR)  
โข ะะพัะตัะธ: 5.4M IDR (-39.1%)

๐ ะะะะะะซะ ะะะะงะะะซ ะะะะะะะฏ:
1. ๐ด GRAB: ััะตะทะฐะฝะธะต ัะตะบะปะฐะผะฝะพะณะพ ะฑัะดะถะตัะฐ โ ะฟะพัะตัะธ 2.1M IDR (38.9%)
2. ๐ก ะะตะดะปะตะฝะฝะฐั ะบััะฝั โ ะฒัะตะผั ะฟัะธะณะพัะพะฒะปะตะฝะธั ะฟะพะฒะปะธัะปะพ ะฝะฐ 1.2M IDR (22.2%)
3. ๐ง๏ธ ะะพะถะดั (12.3ะผะผ) โ ะบัััะตัั ะฝะต ัะฐะฑะพัะฐะปะธ, ะฟะพัะตัะธ 0.8M IDR (14.8%)

๐ฏ ะะะะะะะขะะซะ ะะะะะะะะะะฆะะ:
1. ๐ด ะะพัััะฐะฝะพะฒะธัั ัะตะบะปะฐะผะฝัะน ะฑัะดะถะตั GRAB
2. ๐ก ะฃัะบะพัะธัั ะฟัะพัะตััั ะบััะฝะธ  
3. ๐ก ะะฝะตะดัะธัั ะฟะพะณะพะดะฝัะต ะฟัะพะผะพ-ะฐะบัะธะธ
```

AI ัะธััะตะผะฐ ะฟะพะปะฝะพัััั ะธะฝัะตะณัะธัะพะฒะฐะฝะฐ ั ML ะผะพะดะตะปัั ะธ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฟะพัะปะต ัะฐะทะฒะตัััะฒะฐะฝะธั.

## ะััะธัะตะบัััะฐ ะดะฐะฝะฝัั

ะกะธััะตะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั ะณะธะฑะบัั ัะฐะฑะพัั ั ะดะฐะฝะฝัะผะธ:

### ๐ค ML ะะฑััะตะฝะธะต:
- **ะะพ ัะผะพะปัะฐะฝะธั:** ะฝะฐ ัะฐะนะปะต `merged_dataset.csv` (ััะฐะฑะธะปัะฝัะต ะธััะพัะธัะตัะบะธะต ะดะฐะฝะฝัะต)
- **ะะฟัะธะพะฝะฐะปัะฝะพ:** ะฝะฐ live API ั ัะปะฐะณะพะผ `--from-db`

### ๐ ะะฐะฑะพัะฐ ะฟัะธะปะพะถะตะฝะธั:
- **ะะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั** ะธััะพัะฝะธะบ ะฟะพ `DATABASE_URL`
- **ะัะปะธ ะตััั DATABASE_URL:** ัะฐะฑะพัะฐะตั ั live API PostgreSQL
- **ะัะปะธ ะฝะตั DATABASE_URL:** ัะฐะฑะพัะฐะตั ั ัะฐะนะปะพะผ SQLite

### ๐ฏ ะะตะบะพะผะตะฝะดัะตะผัะน ะฟัะพะดะฐะบัะฝ:
```bash
# ML ะพะฑััะฐะตััั ะฝะฐ ััะฐะฑะธะปัะฝัั ะดะฐะฝะฝัั
python ml/training.py --csv merged_dataset.csv

# ะัะธะปะพะถะตะฝะธะต ัะฐะฑะพัะฐะตั ั live API  
export DATABASE_URL="postgresql://..."
streamlit run streamlit_app.py
```

ะญัะพ ะพะฑะตัะฟะตัะธะฒะฐะตั ััะฐะฑะธะปัะฝะพััั ML ะธ ะฐะบััะฐะปัะฝะพััั ะดะฐะฝะฝัั ะฒ ะพััะตัะฐั.