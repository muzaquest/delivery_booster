# Аналитика продаж ресторанов (FastAPI + PostgreSQL + ETL + ML)

Модульная система аналитики и прогноза продаж с FastAPI, PostgreSQL, ETL, и ML (LightGBM/RandomForest + SHAP).

## Быстрый старт (локально)

Требования: Python 3.11+

1) Виртуальное окружение

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) Установка зависимостей

```bash
pip install -r requirements.txt
```

3) Запуск API

```bash
uvicorn app.main:app --reload
```

4) Streamlit UI (3 вкладки)

```bash
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

Вкладки:
- Анализ ресторана: выбор ресторана и периода, генерация полного отчёта (1–9), сохранение в `reports/` и скачивание `.md`.
- Анализ базы: KPI‑панель (Sales, Orders, AOV, ROAS, MER, Cancels) и MoM сравнение.
- Свободный запрос (AI): ответы на основе БД+ML (для расширенных ответов задайте `OPENAI_API_KEY`).

5) Проверка здоровья

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

Переменные окружения (или `DATABASE_URL`):

- `POSTGRES_HOST` (по умолчанию: localhost)
- `POSTGRES_PORT` (по умолчанию: 5432)
- `POSTGRES_DB` (по умолчанию: analytics)
- `POSTGRES_USER` (по умолчанию: postgres)
- `POSTGRES_PASSWORD` (по умолчанию: postgres)

Создание таблиц:

```bash
python db/init_db.py
```

## ETL

- SQLite-источник: `/workspace/database.sqlite`
- Турпоток (Excel): `/workspace/1.-Data-Kunjungan-2025-3.xls`, `/workspace/Table-1-7-Final-1-1.xls`
- Fake orders: файл `/workspace/Fake orders` содержит Google Sheet ссылку; либо передайте `--fake-orders-sheet`.

Сборка объединённого датасета:

```bash
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv \
  --excel /workspace/1.-Data-Kunjungan-2025-3.xls /workspace/Table-1-7-Final-1-1.xls
```

## Обучение ML-модели и объяснимость (SHAP)

```bash
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
```

- Модели: LightGBM и RandomForest (выбираем чемпиона по MAE)
- Артефакты: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`
- Версия датасета: `metrics.json` содержит хэш, размер и время обучения; в отчёте печатается краткая версия.

## API (после ETL и обучения)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` — сводка: факт/прогноз, AOV, ТОП‑факторы (SHAP)
- `GET /factors?period=...&restaurant_id=...` — список факторов с влиянием в % (SHAP)
- `GET /report-text?period=...&restaurant_id=...` — полный текстовый отчёт на русском (со всеми разделами и ML)

## Тесты

```bash
pytest -q
```
- Smoke‑тест API: `/health`
- Снапшот‑тест отчёта: проверяет наличие разделов 1–9 для одного ресторана/периода

## Развёртывание на Replit

1) Импортируйте репозиторий в Replit.
2) В Secrets (Environment) задайте при необходимости:
   - `GOOGLE_API_KEY` — для Google Sheets с фейковыми заказами
   - `SQLITE_PATH` — путь к SQLite (по умолчанию `/workspace/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` — если используете внешнюю PostgreSQL
3) Первый запуск: выполните ETL и обучение, затем старт сервера и UI:

```bash
python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out /workspace/data/merged_dataset.csv
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
uvicorn app.main:app --host 0.0.0.0 --port 8000 &
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

## Примечания честности данных
- Фейковые заказы вычитаются из заказов и выручки
- Погода — Open‑Meteo по координатам ресторанов (кеш в SQLite; фолбэк по геокодингу)
- Праздники — Nager.Date + локальные балийские (скрейпинг 2024/2025; при недоступности источника — кеш)
- Туристический поток — из предоставленных Excel
- Модель обучается на всём периоде (2.5 года), факторы — SHAP; тривиальные признаки исключены из объяснений

## Пример полного отчёта (Ika Canggu, Q2 2025)

Ниже приведён реальный вывод `/report-text?period=2025-04-01_2025-06-30&restaurant_id=11`:

```
Версия датасета:  · строк: None · тренировался: None · модель: random_forest

📊 1. ИСПОЛНИТЕЛЬНОЕ РЕЗЮМЕ
————————————————————————————————————————————————————————————————————————
💰 Общая выручка: 1 080 876 000 IDR (GRAB: 566 578 400 IDR + GOJEK: 514 297 600 IDR)
📦 Общие заказы: 2648
   ├── 📱 GRAB: 1204 (успешно: 1202, отмены: 2, потери: 0, fake: 0)
   └── 🛵 GOJEK: 1444 (успешно: 1214, отмены: 0, потери: 135, fake: 95)
💵 Средний чек (успешные): общий 447 382 IDR; GRAB 471 363 IDR; GOJEK 423 639 IDR
📊 Дневная выручка: 12 913 649 IDR (средняя по рабочим дням)
⭐ Средний рейтинг: 4.79/5.0
👥 Обслужено клиентов: 1568
   ├── 📱 GRAB: 1161 (новые: 662, повторные: 465, реактивированные: 34)
   └── 🛵 GOJEK: 407 (новые: 104, активные: 246, возвратившиеся: 57)
   💡 Общий охват: 1568 уникальных клиентов
💸 Маркетинговый бюджет: 27 391 282 IDR (2.5% от выручки)
📊 Детализация маркетинговых затрат:
   ┌─ 📱 GRAB:
   │  💰 Бюджет: 18 004 742 IDR
   └─ 🛵 GOJEK:
      💰 Бюджет: 9 386 540 IDR

🎯 ROAS АНАЛИЗ:
├── 📱 GRAB: 25.07x
├── 🛵 GOJEK: 39.59x
└── 🎯 ОБЩИЙ: 30.05x

📈 2. АНАЛИЗ ПРОДАЖ И ТРЕНДОВ
————————————————————————————————————————————————————————————————————————
📊 Динамика по месяцам:
  2025-04: 412 485 700 IDR (30 дней, 13 749 523 IDR/день)
  2025-05: 436 046 600 IDR (31 дней, 14 066 019 IDR/день)
  2025-06: 232 343 700 IDR (30 дней, 7 744 790 IDR/день)

🗓️ Выходные vs Будни:
  📅 Средние продажи в выходные: 13 290 446 IDR
  📅 Средние продажи в будни: 12 913 649 IDR
  📊 Эффект выходных: 2.9%
📊 АНАЛИЗ РАБОЧИХ ДНЕЙ:
🏆 Лучший день: 2025-05-18 - 23 592 200 IDR
   💰 GRAB: 10 000 600 IDR (19 заказов) | GOJEK: 13 591 600 IDR (33 заказов)
📉 Худший день: 2025-06-22 - 0 IDR
   💰 GRAB: — | GOJEK: 0 IDR

👥 3. ДЕТАЛЬНЫЙ АНАЛИЗ КЛИЕНТСКОЙ БАЗЫ
————————————————————————————————————————————————————————————————————————
📊 Структура клиентской базы (GRAB + GOJEK):
  🆕 Новые клиенты: 766
    📱 GRAB: 662 | 🛵 GOJEK: 104
  🔄 Повторные клиенты: 711
    📱 GRAB: 465 | 🛵 GOJEK: 246
  📲 Реактивированные: 91
    📱 GRAB: 34 | 🛵 GOJEK: 57

💰 Доходность по типам клиентов (только GRAB, только с рекламы):
  🆕 Новые: 293 184 400 IDR
  🔄 Повторные: 165 662 300 IDR
  📲 Реактивированные: 13 869 100 IDR

📈 4. МАРКЕТИНГОВАЯ ЭФФЕКТИВНОСТЬ И ВОРОНКА
————————————————————————————————————————————————————————————————————————
📊 Маркетинговая воронка (только GRAB):
  👁️ Показы рекламы: 143408
  🔗 Посещения меню: 6729 (CTR: 4.7%)
  🛒 Добавления в корзину: 1425 (конверсия: 12.1% от кликов)
  📦 Заказы от рекламы: 815 (конверсия: 57.2% от корзины)

  📊 КЛЮЧЕВЫЕ КОНВЕРСИИ:
  • 🎯 Показ → Заказ: 0.6%
  • 🔗 Клик → Заказ: 12.1%
  • 🛒 Корзина → Заказ: 57.2%

  📉 ДЕТАЛЬНЫЙ АНАЛИЗ ВОРОНКИ:
  • 💔 Доля ушедших без покупки: 78.8% (5304 ушли без покупки)
  • 🛒 Доля неоформленных корзин: 42.8% (610 добавили, но не купили)

  💰 ПОТЕНЦИАЛ ОПТИМИЗАЦИИ ВОРОНКИ:
  • 📈 Снижение доли ушедших на 10%: 168 021 303 IDR
  • 🛒 Устранение неоформленных корзин: 337 868 671 IDR
  • 🎯 Общий потенциал: 505 889 974 IDR

💸 Стоимость привлечения (GRAB):
  💰 CPC: 2 676 IDR (расчёт: бюджет ÷ посещения меню)
  💰 CPA: 22 092 IDR (расчёт: бюджет ÷ заказы от рекламы)

5. 💳 ФИНАНСОВЫЕ ПОКАЗАТЕЛИ
————————————————————————————————————————————————————————————————————————
💰 Выплаты:
   ├── 📱 GRAB: 433 012 906 IDR (52.2%)
   ├── 🛵 GOJEK: 396 240 391 IDR (47.8%)
   └── 💎 Общие выплаты: 829 253 297 IDR
📊 Рекламная эффективность:
   ├── 💰 Общие рекламные продажи: 823 063 600 IDR
   ├── 📈 Доля от общих продаж: 76.1%
   ├── 🎯 GRAB ROAS: 25.07x
   └── 🎯 GOJEK ROAS: 39.59x

Дополнительно:
   • Take rate (доля комиссий и удержаний): GRAB 20.4%, GOJEK 21.1%
   • Чистый ROAS: GRAB 19.96x; GOJEK 31.23x
   • Юнит‑экономика рекламного заказа (GRAB): 418 820 IDR

6. ⏰ ОПЕРАЦИОННЫЕ МЕТРИКИ
————————————————————————————————————————————————————————————————————————
🟢 GRAB:
└── ⏰ Время ожидания водителей: 10.1 мин

🟠 GOJEK:
├── ⏱️ Время приготовления: 19.2 мин
├── 🚗 Время доставки: 10.8 мин  
└── ⏰ Время ожидания водителей: 11.7 мин

⚠️ ОПЕРАЦИОННАЯ ЭФФЕКТИВНОСТЬ
————————————————————————————————————————————————————————————————————————
🚫 Отмененные заказы:
   ├── 📱 GRAB: 2 заказа
   └── 🛵 GOJEK: 0 заказа
   💡 Всего отмененных: 2 заказов (0.1%)

🔧 ОПЕРАЦИОННЫЕ СБОИ ПЛАТФОРМ:
├── 📱 GRAB: 3 критичных дня (11:48:00 общее время)
├── 🛵 GOJEK: 1 критичных дня (1:30:00 общее время)
└── 💸 Потенциальные потери: 3 414 410 IDR (0.3%)

🚨 КРИТИЧЕСКИЕ СБОИ (>1 часа):
   • 2025-05-05: GRAB offline 1:26:60 (потери: ~376 162 IDR)
   • 2025-05-05: GOJEK offline 1:30:00 (потери: ~353 226 IDR)
   • 2025-05-11: GRAB offline 8:00:00 (потери: ~2 075 379 IDR)
   • 2025-05-15: GRAB offline 2:21:00 (потери: ~609 643 IDR)

7. ⭐ КАЧЕСТВО ОБСЛУЖИВАНИЯ И УДОВЛЕТВОРЕННОСТЬ (GOJEK)
————————————————————————————————————————————————————————————————————————
📊 Распределение оценок (всего: 148):
  ⭐⭐⭐⭐⭐ 5 звезд: 134 (90.5%)
  ⭐⭐⭐⭐ 4 звезды: 1 (0.7%)
  ⭐⭐⭐ 3 звезды: 4 (2.7%)
  ⭐⭐ 2 звезды: 0 (0.0%)
  ⭐ 1 звезда: 9 (6.1%)

📈 Индекс удовлетворенности: 4.70/5.0
🚨 Негативные отзывы (1-2★): 9 (6.1%)

📊 Частота плохих оценок (не 5★):
  📈 Плохих оценок всего: 14 из 148 (9.5%)
  📦 Успешных заказов GOJEK на 1 плохую оценку: 86.70

8. 🚨 КРИТИЧЕСКИЕ ДНИ (ML)
————————————————————————————————————————————————————————————————————————
📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-01 (выручка: 8 353 000 IDR; отклонение к медиане: -33.4%)
————————————————————————————————————————————————————————————————————————
📊 Факт:
- Выручка: 8 353 000 IDR против медианы 12 560 000 IDR (-33.4%)
💸 Потеря денег: 4 207 000 IDR
🔑 Главные драйверы: GOJEK: время приготовления, Температура (°C)
📌 Контрольные гипотезы: перегруз кухни/бутылочные горлышки, нехватка персонала в пик; меньше курьеров/выше ETA (дождь/праздник)

Краткое резюме:
- Просадка: −4 207 000 IDR (-33.4% к медиане/ожиданию).
- Главные причины: GOJEK: время приготовления (−2 000 000 IDR), Температура (°C) (−1 000 000 IDR).

Негативные факторы (ТОП‑5):
| Фактор | Вклад | Комментарий |
|---|---:|---|
| GOJEK: время приготовления | −2 000 000 IDR (5.1%) | время приготовления ниже нормы на 26% (14.3 против 19.2 мин) |
| Температура (°C) | −1 000 000 IDR (4.8%) | погодные условия снизили спрос |

📌 Главные причины:
- GOJEK: время приготовления (−5.1%): время приготовления ниже нормы на 26% (14.3 против 19.2 мин)
- Среднее время приготовления (мин) (−4.6%): время приготовления ниже нормы на 26% (14.3 против 19.2 мин)
- Температура (°C) (−4.8%): погодные условия снизили спрос

✅ Что смягчало:
• ROAS (GRAB) (+44.4%): ROAS GRAB — без изменений
• Среднее время подтверждения (мин) (+5.0%): подтверждение — без изменений

🎯 Рекомендации:
- 🔴 Перераспределить бюджет в связки с высокой отдачей
- 🟠 Ускорить кухню/подтверждение (−10% к SLA)
- 🟢 Исключить оффлайн на платформах

💰 Потенциал восстановления: 3 100 000 — 4 400 000 IDR (база: 3 700 000 IDR)
📈 Прогноз восстановления (7 дней): 21 700 000 — 30 800 000 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-15 (выручка: 7 940 600 IDR; отклонение к медиане: -36.7%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -36.7%.
- Главные причины: GOJEK: время приготовления, Среднее время приготовления (мин).

Этот день провалился из‑за комбинации операции на кухне/доставке и реклама.

Главные причины (по категориям):
🟢 [Marketing] Рекламный бюджет (GRAB) (3.1%): бюджет GRAB ниже среднего (129 553 IDR vs 219 570 IDR)
🟢 [Operations] GOJEK: время приготовления (4.8%): время приготовления выше нормы (14.7 vs 19.2 мин)
🟢 [Operations] Среднее время приготовления (мин) (4.6%): время приготовления выше нормы (14.7 vs 19.2 мин)
• [External] Дождь: 0.0 мм (0.8%): влияние незначительное
• [External] Праздник: нет (0.0%): влияние незначительное

Что смягчало падение:
• [Marketing] ROAS (GRAB) (+39.5%): реклама GRAB эффективна (24.31x vs 25.35x)
• [Marketing] ROAS (GOJEK) (+19.5%): реклама GOJEK эффективна (36.20x vs 48.06x)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 87 769 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 2 348 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~84 674 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-18 (выручка: 8 764 600 IDR; отклонение к медиане: -30.2%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -30.2%.
- Главные причины: Среднее время приготовления (мин).
- Погода: дождь 9.2 мм снизил готовность заказывать.

Основная причина просадки — операции на кухне/доставке.

Главные причины (по категориям):
🟢 [Operations] Среднее время приготовления (мин) (3.0%): время приготовления выше нормы (19.9 vs 19.2 мин)
• [External] Дождь: 9.2 мм (0.4%): снизил спрос
• [External] Праздник: нет (0.0%): влияние незначительное

Что смягчало падение:
• [Marketing] ROAS (GRAB) (+29.1%): реклама GRAB эффективна (19.57x vs 25.35x)
• [Marketing] ROAS (GOJEK) (+18.7%): реклама GOJEK эффективна (38.88x vs 48.06x)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 141 134 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 922 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~137 491 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-13 (выручка: 7 812 400 IDR; отклонение к медиане: -37.8%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -37.8%.
- Главные причины: Среднее время приготовления (мин).
- Погода: дождь 32.5 мм снизил готовность заказывать.

Основная причина просадки — операции на кухне/доставке.

Главные причины (по категориям):
🟢 [Operations] Среднее время приготовления (мин) (3.1%): время приготовления выше нормы (15.7 vs 19.2 мин)
• [External] Дождь: 32.5 мм (1.3%): снизил спрос
• [External] Праздник: нет (0.0%): влияние незначительное

Что смягчало падение:
• [Marketing] ROAS (GRAB) (+25.3%): реклама GRAB эффективна (23.51x vs 25.35x)
• [Marketing] ROAS (GOJEK) (+18.8%): реклама GOJEK эффективна (22.91x vs 48.06x)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 1 940 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ -12 036 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~-10 095 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-18 (выручка: 8 522 600 IDR; отклонение к медиане: -32.1%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -32.1%.
- Главные причины: ROAS (GRAB), Среднее время приготовления (мин).
- Доступность: оффлайн GRAB 0:08:00.

Этот день провалился из‑за комбинации операции на кухне/доставке и реклама.

Главные причины (по категориям):
🟠 [Marketing] ROAS (GRAB) (12.1%): реклама GRAB неэффективна (16.24x vs 25.35x)
🟠 [Operations] Среднее время приготовления (мин) (9.9%): время приготовления выше нормы (10.2 vs 19.2 мин)
🟠 [Operations] GOJEK: время приготовления (9.4%): время приготовления выше нормы (10.2 vs 19.2 мин)
• [External] Дождь: 0.0 мм (0.7%): влияние незначительное
• [External] Праздник: нет (0.0%): влияние незначительное

Что смягчало падение:
• [Operations] Среднее время подтверждения (мин) (+18.8%): подтверждение быстрее обычного (0.0 vs 0.0 мин)
• [Operations] GOJEK: время подтверждения (+16.2%): подтверждение быстрее обычного (0.0 vs 0.0 мин)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 6 678 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 5 126 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 3 628 IDR (Medium)

💰 Потенциал восстановления: ~15 432 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-22 (выручка: 0 IDR; отклонение к медиане: -100.0%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -100.0%.
- Главные причины: Рекламный бюджет (суммарно), ROAS (GRAB).
- Погода: дождь 2.4 мм снизил готовность заказывать.

Этот день провалился из‑за комбинации реклама и операции на кухне/доставке.

Главные причины (по категориям):
🔴 [Marketing] Рекламный бюджет (суммарно) (48.6%): изменение рекламной активности
🟠 [Marketing] ROAS (GRAB) (11.4%): рекламная эффективность ниже нормы
🟢 [Marketing] Показы рекламы (6.9%): влияющий фактор периода
🟢 [Operations] GOJEK: время подтверждения (4.6%): скорость подтверждения
🟢 [Operations] Среднее время подтверждения (мин) (4.4%): скорость подтверждения
• [External] Дождь: 2.4 мм (0.2%): снизил спрос
• [External] Праздник: нет (0.0%): влияние незначительное

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 0 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 0 IDR (Medium)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~0 IDR

Справка по периоду:
  • 🌧️ Дождь: 2.2%
  • 🎌 Праздники: 0.0%

Источники: SQLite (grab_stats, gojek_stats), Open‑Meteo, Holidays cache

9. 🎯 СТРАТЕГИЧЕСКИЕ РЕКОМЕНДАЦИИ
————————————————————————————————————————————————————————————————————————
Приоритеты по факторам (ML):
  • [Marketing] ROAS (GRAB)
  • [Marketing] ROAS (GOJEK)
  • [Marketing] Рекламный бюджет (суммарно)
  • [Operations] GOJEK: время подтверждения
  • [Operations] Среднее время подтверждения (мин)
  • [Marketing] Рекламный бюджет (GRAB)
  • [Operations] GOJEK: время приготовления
  • [Operations] Среднее время приготовления (мин)

Вклад групп факторов:
  • Operations: 20.3%
  • Marketing: 62.7%
  • External: 17.0%

Рекомендуемые действия:
  • Перераспределить бюджет в связки с лучшим ROAS; тест креативов и аудиторий; корректировка ставок
  • Погодные промо и бонусы курьерам в дождь; перенос активностей на «сухие» окна
  • Учитывать локальные праздники в планировании (снижение бюджета/акции на следующий день)
  • Контроль качества и рейтингов: работа с негативом, улучшение времени ожидания