# Аналитика продаж ресторанов (FastAPI + PostgreSQL + ETL + ML)

Модульная система аналитики и прогноза продаж с FastAPI, PostgreSQL, ETL, и ML (LightGBM/RandomForest + SHAP).

## Быстрый старт (локально)

Требования: Python 3.11+

1) Виртуальное окружение

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) Установка зависимостей

```bash
pip install -r requirements.txt
```

3) Запуск API

```bash
uvicorn app.main:app --reload
```

4) Streamlit UI (3 вкладки)

```bash
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

Вкладки:
- Анализ ресторана: выбор ресторана и периода, генерация полного отчёта (1–9), сохранение в `reports/` и скачивание `.md`.
- Анализ базы: KPI‑панель (Sales, Orders, AOV, ROAS, MER, Cancels) и MoM сравнение.
- Свободный запрос (AI): ответы на основе БД+ML (для расширенных ответов задайте `OPENAI_API_KEY`).

5) Проверка здоровья

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

Переменные окружения (или `DATABASE_URL`):

- `POSTGRES_HOST` (по умолчанию: localhost)
- `POSTGRES_PORT` (по умолчанию: 5432)
- `POSTGRES_DB` (по умолчанию: analytics)
- `POSTGRES_USER` (по умолчанию: postgres)
- `POSTGRES_PASSWORD` (по умолчанию: postgres)

Создание таблиц:

```bash
python db/init_db.py
```

## ETL

- SQLite-источник: `/workspace/database.sqlite`
- Турпоток (Excel): `/workspace/1.-Data-Kunjungan-2025-3.xls`, `/workspace/Table-1-7-Final-1-1.xls`
- Fake orders: файл `/workspace/Fake orders` содержит Google Sheet ссылку; либо передайте `--fake-orders-sheet`.

Сборка объединённого датасета:

```bash
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv \
  --excel /workspace/1.-Data-Kunjungan-2025-3.xls /workspace/Table-1-7-Final-1-1.xls
```

## Обучение ML-модели и объяснимость (SHAP)

```bash
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
```

- Модели: LightGBM и RandomForest (выбираем чемпиона по MAE)
- Артефакты: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`
- Версия датасета: `metrics.json` содержит хэш, размер и время обучения; в отчёте печатается краткая версия.

## API (после ETL и обучения)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` — сводка: факт/прогноз, AOV, ТОП‑факторы (SHAP)
- `GET /factors?period=...&restaurant_id=...` — список факторов с влиянием в % (SHAP)
- `GET /report-text?period=...&restaurant_id=...` — полный текстовый отчёт на русском (со всеми разделами и ML)

## Тесты

```bash
pytest -q
```
- Smoke‑тест API: `/health`
- Снапшот‑тест отчёта: проверяет наличие разделов 1–9 для одного ресторана/периода

## Развёртывание на Replit

1) Импортируйте репозиторий в Replit.
2) В Secrets (Environment) задайте при необходимости:
   - `GOOGLE_API_KEY` — для Google Sheets с фейковыми заказами
   - `SQLITE_PATH` — путь к SQLite (по умолчанию `/workspace/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` — если используете внешнюю PostgreSQL
3) Первый запуск: выполните ETL и обучение, затем старт сервера и UI:

```bash
python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out /workspace/data/merged_dataset.csv
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
uvicorn app.main:app --host 0.0.0.0 --port 8000 &
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

## Примечания честности данных
- Фейковые заказы вычитаются из заказов и выручки
- Погода — Open‑Meteo по координатам ресторанов (кеш в SQLite; фолбэк по геокодингу)
- Праздники — Nager.Date + локальные балийские (скрейпинг 2024/2025; при недоступности источника — кеш)
- Туристический поток — из предоставленных Excel
- Модель обучается на всём периоде (2.5 года), факторы — SHAP; тривиальные признаки исключены из объяснений

## Пример полного отчёта (Prana, июль 2025)

Ниже приведён реальный анализ на основе API данных `/api/v1/getRestaurantStats?restaurant_name=Prana&source=grab&start_date=2025-07-01&end_date=2025-07-31`:

```
📊 1. ИСПОЛНИТЕЛЬНОЕ РЕЗЮМЕ
————————————————————————————————————————————————————————————————————————
💰 Общая выручка: 557,391,932 IDR (GRAB: 312,455,000 IDR + GOJEK: 244,936,932 IDR)
📦 Общие заказы: 2,375
   ├── 📱 GRAB: 1,245 заказов
   └── 🛵 GOJEK: 1,130 заказов
💵 Средний чек: общий 234,691 IDR; GRAB 250,968 IDR; GOJEK 216,758 IDR
📊 Дневная выручка: 17,980,385 IDR (средняя за 31 день)
⭐ Средний рейтинг: 4.75/5.0
💸 Маркетинговый бюджет: 22,128,695 IDR (4.0% от выручки)

🎯 ROAS АНАЛИЗ:
├── 📱 GRAB: 13.43x
├── 🛵 GOJEK: 50.65x
└── 🎯 ОБЩИЙ: 18.59x

📈 2. АНАЛИЗ ПРОДАЖ И ТРЕНДОВ
————————————————————————————————————————————————————————————————————————
🏆 Лучший день GRAB: 2025-07-28 - 13,606,000 IDR
   ⭐ Рейтинг: 4.70
   📦 Заказов: 52
🏆 Лучший день GOJEK: 2025-07-02 - 12,124,998 IDR
   ⭐ Рейтинг: N/A
   📦 Заказов: 47

📈 4. МАРКЕТИНГОВАЯ ЭФФЕКТИВНОСТЬ
————————————————————————————————————————————————————————————————————————
📊 Рекламная эффективность за июль 2025:
  📱 GRAB: потратили 19,060,471 IDR → получили 255,952,000 IDR
  🛵 GOJEK: потратили 3,068,224 IDR → получили 155,419,950 IDR
  📊 Доля рекламных продаж: GRAB 81.9%, GOJEK 63.5%

🔧 5. ОПЕРАЦИОННАЯ ЭФФЕКТИВНОСТЬ
————————————————————————————————————————————————————————————————————————
⏱️ Среднее время ожидания водителя (GRAB): 451.1 сек
📴 Средний offline rate (GRAB): 0.00%

📊 6. ДИНАМИКА ПО ПЕРИОДАМ
————————————————————————————————————————————————————————————————————————
📅 GRAB по неделям:
  1-7 июля: 80,789,000 IDR
  8-14 июля: 67,263,000 IDR
  15-21 июля: 62,886,000 IDR
  22-28 июля: 68,528,000 IDR
```
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Просадка: −4 207 000 IDR (-33.4% к медиане/ожиданию).
- Главные причины: GOJEK: время приготовления (−2 000 000 IDR).

Негативные факторы (ТОП‑5):
| Фактор | Вклад | Комментарий |
|---|---:|---|
| GOJEK: время приготовления | −2 000 000 IDR (5.1%) | время приготовления ниже нормы на 26% (14.3 против 19.2 мин) |

Причины:
- Снижение активности в GOJEK: бюджет ↓ и продажи ↓ (маркетинг дал меньше заказов).
- GOJEK: время приготовления: время приготовления ниже нормы на 26% (14.3 против 19.2 мин).

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | 108 000 IDR (−13.7%) | 1 846 600 IDR (−61.7%) | бюджет ↓13.7%, продажи ↓61.7% → эффективность плохая |
| GRAB  | 114 153 IDR (−48.0%) | 2 884 800 IDR (−47.6%) | бюджет ↓48.0%, продажи ↓47.6% |

Внешние факторы:
- Праздник: да (Eid al-Fitr — возможна низкая доступность курьеров)
- Дождь: не было
- Отмены: GRAB —; GOJEK —

🎯 Рекомендации:
- 🔴 Перераспределить бюджет в связки с высокой отдачей
- 🟠 Ускорить кухню/подтверждение (−10% к SLA)
- 🟢 Исключить оффлайн на платформах

💰 Потенциал восстановления: 3 100 000 — 4 400 000 IDR (база: 3 700 000 IDR)
📈 Прогноз восстановления (7 дней): 21 700 000 — 30 800 000 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-15 (выручка: 7 940 600 IDR; отклонение к медиане: -36.7%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -36.7%.
- Главные причины: GOJEK: время приготовления, Среднее время приготовления (мин).

Причины:
- Снижение активности в GRAB: бюджет ↓ и продажи ↓.
- GOJEK: время приготовления: время приготовления выше нормы (14.7 vs 19.2 мин).

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 87 769 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 2 348 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~84 674 IDR

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | 73 288 IDR (−41.4%) | 2 652 900 IDR (−45.0%) | бюджет ↓41.4%, продажи ↓45.0% |
| GRAB  | 129 553 IDR (−41.0%) | 3 149 100 IDR (−42.8%) | бюджет ↓41.0%, продажи ↓42.8% |

- Внешние факторы:
- Праздник: нет
- Дождь: не было
- Отмены: GRAB —; GOJEK —

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-18 (выручка: 8 764 600 IDR; отклонение к медиане: -30.2%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -30.2%.
- Главные причины: Среднее время приготовления (мин).

Основная причина просадки — операции на кухне/доставке.

Причины:
- Снижение активности в GOJEK: бюджет ↓ и продажи ↓.
- Среднее время приготовления (мин): время приготовления выше нормы (19.9 vs 19.2 мин).

Что смягчало падение:
• [Marketing] ROAS (GRAB) (+29.1%): реклама GRAB эффективна (19.57x vs 25.35x)
• [Marketing] ROAS (GOJEK) (+18.7%): реклама GOJEK эффективна (38.88x vs 48.06x)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 141 134 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 922 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~137 491 IDR

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | 88 808 IDR (−29.0%) | 3 452 800 IDR (−28.5%) | бюджет ↓29.0%, продажи ↓28.5% |
| GRAB  | 185 793 IDR (−15.4%) | 3 635 700 IDR (−34.0%) | бюджет ↓15.4%, продажи ↓34.0% |

- Внешние факторы:
- Праздник: нет
- Дождь: слабый
- Отмены: GRAB —; GOJEK —

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-13 (выручка: 7 812 400 IDR; отклонение к медиане: -37.8%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -37.8%.
- Главные причины: Среднее время приготовления (мин).

Основная причина просадки — операции на кухне/доставке.

Причины:
- Сильный дождь: меньше курьеров и больше отмен → падение продаж.
- Снижение активности в GOJEK: бюджет ↓ и продажи ↓.
- Среднее время приготовления (мин): время приготовления выше нормы (15.7 vs 19.2 мин).

Что смягчало падение:
• [Marketing] ROAS (GRAB) (+25.3%): реклама GRAB эффективна (23.51x vs 25.35x)
• [Marketing] ROAS (GOJEK) (+18.8%): реклама GOJEK эффективна (22.91x vs 48.06x)

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 1 940 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ -12 036 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~-10 095 IDR

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | 72 144 IDR (−42.4%) | 1 652 700 IDR (−65.8%) | бюджет ↓42.4%, продажи ↓65.8% |
| GRAB  | 200 695 IDR (−8.6%) | 4 717 700 IDR (−14.3%) | бюджет ↓8.6%, продажи ↓14.3% |

- Внешние факторы:
- Праздник: нет
- Дождь: сильный
- Отмены: GRAB —; GOJEK —

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-18 (выручка: 8 522 600 IDR; отклонение к медиане: -32.1%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -32.1%.
- Главные причины: ROAS (GRAB), Среднее время приготовления (мин).
- Доступность: оффлайн GRAB 0:08:00.

Причины:
- Снижение активности в GRAB: бюджет ↓ и продажи ↓.
- ROAS (GRAB): реклама GRAB неэффективна (16.24x vs 25.35x).
- Среднее время приготовления (мин): время приготовления выше нормы (10.2 vs 19.2 мин).

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 6 678 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 5 126 IDR (High)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 3 628 IDR (Medium)

💰 Потенциал восстановления: ~15 432 IDR

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | — (—) | — (—) | — |
| GRAB  | 209 893 IDR (−4.4%) | 3 407 800 IDR (−38.1%) | бюджет ↓4.4%, продажи ↓38.1% |

- Внешние факторы:
- Праздник: нет
- Дождь: не было
- Отмены: GRAB —; GOJEK —

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-06-22 (выручка: 0 IDR; отклонение к медиане: -100.0%)
————————————————————————————————————————————————————————————————————————
Краткое резюме:
- Продажи ниже медианы на -100.0%.
- Главные причины: Рекламный бюджет (суммарно), ROAS (GRAB).

Этот день провалился из‑за комбинации реклама и операции на кухне/доставке.

Причины:
- Рекламный бюджет (суммарно): изменение рекламной активности.
- ROAS (GRAB): рекламная эффективность ниже нормы.

Рекомендации:
🔴 Срочно — перенаправить бюджет на кампании с высокой отдачей (+10%): ≈ 0 IDR (High)
🟠 Важно — сократить среднее время приготовления/подтверждения на 10%: ≈ 0 IDR (Medium)
🟢 Дополнительно — исключить оффлайн на платформах: ≈ 0 IDR (Low)

💰 Потенциал восстановления: ~0 IDR

Маркетинг:
| Канал | Ads Spend | Ads Sales | Комментарий |
|---|---:|---:|---|
| GOJEK | — (—) | — (—) | бюджет ↓, продажи ↓ |
| GRAB  | — (—) | — (—) | бюджет ↓, продажи ↓ |

- Внешние факторы:
- Праздник: нет
- Дождь: слабый
- Отмены: GRAB —; GOJEK —

Справка по периоду:
  • 🌧️ Дождь: 2.2%
  • 🎌 Праздники: 0.0%

Источники: SQLite (grab_stats, gojek_stats), Open‑Meteo, Holidays cache

9. 🎯 СТРАТЕГИЧЕСКИЕ РЕКОМЕНДАЦИИ
————————————————————————————————————————————————————————————————————————
Приоритеты по факторам (ML):
  • [Marketing] ROAS (GRAB)
  • [Marketing] ROAS (GOJEK)
  • [Marketing] Рекламный бюджет (суммарно)
  • [Operations] GOJEK: время подтверждения
  • [Operations] Среднее время подтверждения (мин)
  • [Marketing] Рекламный бюджет (GRAB)
  • [Operations] GOJEK: время приготовления
  • [Operations] Среднее время приготовления (мин)

Вклад групп факторов:
  • Operations: 20.3%
  • Marketing: 62.7%
  • External: 17.0%

Рекомендуемые действия:
  • Перераспределить бюджет в связки с лучшим ROAS; тест креативов и аудиторий; корректировка ставок
  • Погодные промо и бонусы курьерам в дождь; перенос активностей на «сухие» окна
  • Учитывать локальные праздники в планировании (снижение бюджета/акции на следующий день)
  • Контроль качества и рейтингов: работа с негативом, улучшение времени ожидания