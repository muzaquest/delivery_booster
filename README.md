# Аналитика продаж ресторанов (FastAPI + PostgreSQL + ETL + ML)

Модульная система аналитики и прогноза продаж с FastAPI, PostgreSQL, ETL, и ML (LightGBM/RandomForest + SHAP).

## Быстрый старт (локально)

Требования: Python 3.11+

1) Виртуальное окружение

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) Установка зависимостей

```bash
pip install -r requirements.txt
```

3) Запуск API

```bash
uvicorn app.main:app --reload
```

4) Streamlit UI (3 вкладки)

```bash
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

Вкладки:
- Анализ ресторана: выбор ресторана и периода, генерация полного отчёта (1–9), сохранение в `reports/` и скачивание `.md`.
- Анализ базы: KPI‑панель (Sales, Orders, AOV, ROAS, MER, Cancels) и MoM сравнение.
- Свободный запрос (AI): ответы на основе БД+ML (для расширенных ответов задайте `OPENAI_API_KEY`).

5) Проверка здоровья

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

Переменные окружения (или `DATABASE_URL`):

- `POSTGRES_HOST` (по умолчанию: localhost)
- `POSTGRES_PORT` (по умолчанию: 5432)
- `POSTGRES_DB` (по умолчанию: analytics)
- `POSTGRES_USER` (по умолчанию: postgres)
- `POSTGRES_PASSWORD` (по умолчанию: postgres)

Создание таблиц:

```bash
python db/init_db.py
```

## ETL

- SQLite-источник: `/workspace/database.sqlite`
- Турпоток (Excel): `/workspace/1.-Data-Kunjungan-2025-3.xls`, `/workspace/Table-1-7-Final-1-1.xls`
- Fake orders: файл `/workspace/Fake orders` содержит Google Sheet ссылку; либо передайте `--fake-orders-sheet`.

Сборка объединённого датасета:

```bash
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv \
  --excel /workspace/1.-Data-Kunjungan-2025-3.xls /workspace/Table-1-7-Final-1-1.xls
```

## Обучение ML-модели и объяснимость (SHAP)

```bash
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
```

- Модели: LightGBM и RandomForest (выбираем чемпиона по MAE)
- Артефакты: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`
- Версия датасета: `metrics.json` содержит хэш, размер и время обучения; в отчёте печатается краткая версия.

## API (после ETL и обучения)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` — сводка: факт/прогноз, AOV, ТОП‑факторы (SHAP)
- `GET /factors?period=...&restaurant_id=...` — список факторов с влиянием в % (SHAP)
- `GET /report-text?period=...&restaurant_id=...` — полный текстовый отчёт на русском (со всеми разделами и ML)

## Тесты

```bash
pytest -q
```
- Smoke‑тест API: `/health`
- Снапшот‑тест отчёта: проверяет наличие разделов 1–9 для одного ресторана/периода

## Развёртывание на Replit

1) Импортируйте репозиторий в Replit.
2) В Secrets (Environment) задайте при необходимости:
   - `GOOGLE_API_KEY` — для Google Sheets с фейковыми заказами
   - `SQLITE_PATH` — путь к SQLite (по умолчанию `/workspace/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` — если используете внешнюю PostgreSQL
3) Первый запуск: выполните ETL и обучение, затем старт сервера и UI:

```bash
python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out /workspace/data/merged_dataset.csv
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
uvicorn app.main:app --host 0.0.0.0 --port 8000 &
streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0
```

## Примечания честности данных
- Фейковые заказы вычитаются из заказов и выручки
- Погода — Open‑Meteo по координатам ресторанов (кеш в SQLite; фолбэк по геокодингу)
- Праздники — Nager.Date + локальные балийские (скрейпинг 2024/2025; при недоступности источника — кеш)
- Туристический поток — из предоставленных Excel
- Модель обучается на всём периоде (2.5 года), факторы — SHAP; тривиальные признаки исключены из объяснений

## Пример полного отчёта (Ika Canggu, Q2 2025)

Ниже приведён реальный вывод `/report-text?period=2025-04-01_2025-06-30&restaurant_id=11`:

```
Версия датасета:  · строк: None · тренировался: None · модель: random_forest


📊 1. ИСПОЛНИТЕЛЬНОЕ РЕЗЮМЕ
————————————————————————————————————————————————————————————————————————
💰 Общая выручка: 486 883 500 IDR (GRAB: 379 243 900 IDR + GOJEK: 107 639 600 IDR)

📦 Общие заказы: 2670
   ├── 📱 GRAB: 1973 (успешно: 1701, отмены: 2, потери: 0, fake: 270)
   └── 🛵 GOJEK: 697 (успешно: 548, отмены: 3, потери: 40, fake: 106)
💵 Средний чек (успешные): общий 216 489 IDR; GRAB 222 953 IDR; GOJEK 196 423 IDR

📊 Дневная выручка: 7 850 068 IDR (средняя по рабочим дням)
⭐ Средний рейтинг: 4.79/5.0
👥 Обслужено клиентов: 1910
   ├── 📱 GRAB: 1797 (новые: 1041, повторные: 722, реактивированные: 34)
   └── 🛵 GOJEK: 113 (новые: 47, активные: 62, возвратившиеся: 4)
   💡 Общий охват: 1910 уникальных клиентов
💸 Маркетинговый бюджет: 18 748 004 IDR (3.9% от выручки)
📊 Детализация маркетинговых затрат:
   ┌─ 📱 GRAB:
   │  💰 Бюджет: 16 490 986 IDR
   └─ 🛵 GOJEK:
      💰 Бюджет: 2 257 018 IDR

🎯 ROAS АНАЛИЗ:
├── 📱 GRAB: 13.90x
├── 🛵 GOJEK: 23.13x
└── 🎯 ОБЩИЙ: 15.01x

📈 2. АНАЛИЗ ПРОДАЖ И ТРЕНДОВ
————————————————————————————————————————————————————————————————————————
📊 Динамика по месяцам:
  2025-04: 222 865 600 IDR (30 дней, 7 428 853 IDR/день)
  2025-05: 264 017 900 IDR (31 дней, 8 516 706 IDR/день)

🗓️ Выходные vs Будни:
  📅 Средние продажи в выходные: 8 322 382 IDR
  📅 Средние продажи в будни: 7 850 068 IDR
  📊 Эффект выходных: 6.0%
📊 АНАЛИЗ РАБОЧИХ ДНЕЙ:
🏆 Лучший день: 2025-05-12 - 11 425 200 IDR
   💰 GRAB: 9 424 700 IDR (41 заказов) | GOJEK: 2 000 500 IDR (13 заказов)
📉 Худший день: 2025-04-21 - 1 793 000 IDR
   💰 GRAB: — | GOJEK: 1 793 000 IDR

👥 3. ДЕТАЛЬНЫЙ АНАЛИЗ КЛИЕНТСКОЙ БАЗЫ
————————————————————————————————————————————————————————————————————————
📊 Структура клиентской базы (GRAB + GOJEK):
  🆕 Новые клиенты: 1088
    📱 GRAB: 1041 | 🛵 GOJEK: 47
  🔄 Повторные клиенты: 784
    📱 GRAB: 722 | 🛵 GOJEK: 62
  📲 Реактивированные: 38
    📱 GRAB: 34 | 🛵 GOJEK: 4

💰 Доходность по типам клиентов (только GRAB, только с рекламы):
  🆕 Новые: 145 191 900 IDR
  🔄 Повторные: 71 932 200 IDR
  📲 Реактивированные: 6 552 500 IDR

📈 4. МАРКЕТИНГОВАЯ ЭФФЕКТИВНОСТЬ И ВОРОНКА
————————————————————————————————————————————————————————————————————————
📊 Маркетинговая воронка (только GRAB):
  👁️ Показы рекламы: 132873
  🔗 Посещения меню: 5905 (CTR: 4.4%)
  🛒 Добавления в корзину: 1450 (конверсия: 19.1% от кликов)
  📦 Заказы от рекламы: 1129 (конверсия: 77.9% от корзины)

  📊 КЛЮЧЕВЫЕ КОНВЕРСИИ:
  • 🎯 Показ → Заказ: 0.8%
  • 🔗 Клик → Заказ: 19.1%
  • 🛒 Корзина → Заказ: 77.9%

  📉 ДЕТАЛЬНЫЙ АНАЛИЗ ВОРОНКИ:
  • 💔 Доля ушедших без покупки: 75.4% (4455 ушли без покупки)
  • 🛒 Доля неоформленных корзин: 22.1% (321 добавили, но не купили)

  💰 ПОТЕНЦИАЛ ОПТИМИЗАЦИИ ВОРОНКИ:
  • 📈 Снижение доли ушедших на 10%: 70 441 968 IDR
  • 🛒 Устранение неоформленных корзин: 65 187 281 IDR
  • 🎯 Общий потенциал: 135 629 250 IDR

💸 Стоимость привлечения (GRAB):
  💰 CPC: 2 793 IDR (расчёт: бюджет ÷ посещения меню)
  💰 CPA: 14 607 IDR (расчёт: бюджет ÷ заказы от рекламы)

5. 💳 ФИНАНСОВЫЕ ПОКАЗАТЕЛИ
————————————————————————————————————————————————————————————————————————
💰 Выплаты:
   ├── 📱 GRAB: 275 831 914 IDR (77.6%)
   ├── 🛵 GOJEK: 79 783 197 IDR (22.4%)
   └── 💎 Общие выплаты: 355 615 111 IDR
📊 Рекламная эффективность:
   ├── 💰 Общие рекламные продажи: 281 467 000 IDR
   ├── 📈 Доля от общих продаж: 57.8%
   ├── 🎯 GRAB ROAS: 13.90x
   └── 🎯 GOJEK ROAS: 23.13x

Дополнительно:
   • Take rate (доля комиссий и удержаний): GRAB 22.9%, GOJEK 23.8%
   • Чистый ROAS: GRAB 10.72x; GOJEK 17.63x
   • Юнит‑экономика рекламного заказа (GRAB): 141 925 IDR

6. ⏰ ОПЕРАЦИОННЫЕ МЕТРИКИ
————————————————————————————————————————————————————————————————————————
🟢 GRAB:
└── ⏰ Время ожидания водителей: 6.2 мин

🟠 GOJEK:
├── ⏱️ Время приготовления: 16.6 мин
├── 🚗 Время доставки: 14.1 мин  
└── ⏰ Время ожидания водителей: 8.9 мин

⚠️ ОПЕРАЦИОННАЯ ЭФФЕКТИВНОСТЬ
————————————————————————————————————————————————————————————————————————
🚫 Отмененные заказы:
   ├── 📱 GRAB: 2 заказа
   └── 🛵 GOJEK: 3 заказа
   💡 Всего отмененных: 5 заказов (0.2%)

🔧 ОПЕРАЦИОННЫЕ СБОИ ПЛАТФОРМ:
├── 📱 GRAB: 2 критичных дня (6:57:00 общее время)
├── 🛵 GOJEK: 3 критичных дня (4:42:01 общее время)
└── 💸 Потенциальные потери: 2 145 957 IDR (0.4%)

🚨 КРИТИЧЕСКИЕ СБОИ (>1 часа):
   • 2025-04-02: GOJEK offline 1:10:00 (потери: ~85 778 IDR)
   • 2025-04-09: GOJEK offline 1:01:48 (потери: ~75 730 IDR)
   • 2025-04-27: GOJEK offline 2:30:13 (потери: ~184 076 IDR)
   • 2025-05-06: GRAB offline 1:00:00 (потери: ~259 046 IDR)
   • 2025-05-15: GRAB offline 5:57:00 (потери: ~1 541 326 IDR)

7. ⭐ КАЧЕСТВО ОБСЛУЖИВАНИЯ И УДОВЛЕТВОРЕННОСТЬ (GOJEK)
————————————————————————————————————————————————————————————————————————
📊 Распределение оценок (всего: 38):
  ⭐⭐⭐⭐⭐ 5 звезд: 35 (92.1%)
  ⭐⭐⭐⭐ 4 звезды: 1 (2.6%)
  ⭐⭐⭐ 3 звезды: 0 (0.0%)
  ⭐⭐ 2 звезды: 0 (0.0%)
  ⭐ 1 звезда: 2 (5.3%)

📈 Индекс удовлетворенности: 4.76/5.0
🚨 Негативные отзывы (1-2★): 2 (5.3%)

📊 Частота плохих оценок (не 5★):
  📈 Плохих оценок всего: 3 из 38 (7.9%)
  📦 Успешных заказов GOJEK на 1 плохую оценку: 182.70

8. 🚨 КРИТИЧЕСКИЕ ДНИ (ML)
————————————————————————————————————————————————————————————————————————
📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-02 (выручка: 5 145 100 IDR; отклонение к медиане: -34.7%)

————————————————————————————————————————————————————————————————————————
🔎 Факторы, повлиявшие на результат (ML):
  • [Marketing] ROAS (GRAB): ↓ вклад ~251 505 IDR (46.6%)
  • [Operations] GOJEK: время приготовления: ↓ вклад ~58 765 IDR (10.9%)
  • [Operations] Среднее время приготовления (мин): ↓ вклад ~49 576 IDR (9.2%)
  • [Marketing] ROAS (GOJEK): ↓ вклад ~31 151 IDR (5.8%)
  • [Operations] Среднее время подтверждения (мин): ↑ вклад ~22 946 IDR (4.3%)
  • [Marketing] Рекламный бюджет (GOJEK): ↓ вклад ~22 240 IDR (4.1%)
  • [Operations] GOJEK: время подтверждения: ↑ вклад ~14 629 IDR (2.7%)
  • [External] День недели: ↓ вклад ~12 994 IDR (2.4%)
  • [Marketing] Показы рекламы: ↑ вклад ~10 643 IDR (2.0%)
  • [External] Дождь (мм): ↑ вклад ~9 178 IDR (1.7%)
  • [Marketing] mkt impressions GRAB: ↑ вклад ~8 347 IDR (1.5%)
  • [External] rain lag 1: ↑ вклад ~6 027 IDR (1.1%)
  • [Marketing] Рекламный бюджет (суммарно): ↑ вклад ~5 485 IDR (1.0%)

📊 Вклад групп факторов:
  • Operations: 28.1%
  • Marketing: 61.1%
  • External: 10.8%

📅 Контекст дня:
  • 📱 GRAB оффлайн: 0:08:45
  • 🛵 GOJEK оффлайн: 1:10:00
  • 🎯 GRAB: spend 174 770 IDR, ROAS 9.26x
  • 🎯 GOJEK: spend 48 000 IDR, ROAS 15.23x
  • ⏱️ Приготовление: 15.05 мин
  • ⏳ Подтверждение: 0.00 мин
  • 🚗 Доставка: 11.00 мин
  • 🌧️ Дождь: 0.6 мм; 🌡️ Темп.: 26.9°C; 🌬️ Ветер: 9.3; 💧Влажность: 80.0
  • 🎌 Праздник: нет

🧠 Пояснение простыми словами:
  • Реклама GRAB отработала слабее обычного: ROAS 9.26x против среднего 13.84x (-33%).

  • Бюджет GRAB ниже среднего: 174 770 IDR vs 274 850 IDR (-36%).
  • На GOJEK отдача рекламы тоже слабее: ROAS 15.23x против 23.82x (-36%).
  • Бюджет GOJEK выше среднего: 48 000 IDR vs 39 597 IDR (+21%).
  • Время приготовления 15.1 мин против среднего 16.6 мин (-9%).
  • Время подтверждения 0.0 мин против 0.0 мин (+0%).
  • Доставка 11.0 мин против 14.1 мин (-22%).
  • Оффлайн GRAB: 0:08:45 против среднего 0:10:01 (-13%).
  • Отмены GOJEK: 0 против среднего 0 (-100%).

🔮 What‑if (−10% SLA, +10% бюджет, без оффлайна): ожидаемый прирост ~40 930 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-08 (выручка: 4 782 300 IDR; отклонение к медиане: -39.3%)

————————————————————————————————————————————————————————————————————————
🔎 Факторы, повлиявшие на результат (ML):
  • [Marketing] ROAS (GRAB): ↓ вклад ~486 639 IDR (62.8%)
  • [Marketing] ROAS (GOJEK): ↓ вклад ~50 860 IDR (6.6%)
  • [Marketing] Рекламный бюджет (GOJEK): ↓ вклад ~33 083 IDR (4.3%)
  • [External] День недели: ↓ вклад ~25 885 IDR (3.3%)
  • [Marketing] Рекламный бюджет (GRAB): ↑ вклад ~21 757 IDR (2.8%)
  • [Operations] GOJEK: время подтверждения: ↑ вклад ~20 874 IDR (2.7%)
  • [Operations] Среднее время подтверждения (мин): ↑ вклад ~15 348 IDR (2.0%)
  • [Operations] Среднее время доставки (мин): ↑ вклад ~15 165 IDR (2.0%)
  • [Marketing] Рекламный бюджет (суммарно): ↑ вклад ~14 713 IDR (1.9%)
  • [Operations] GOJEK: время доставки: ↑ вклад ~14 315 IDR (1.8%)
  • [External] Влажность (%): ↓ вклад ~10 578 IDR (1.4%)
  • [External] Выходной: ↓ вклад ~6 545 IDR (0.8%)
  • [External] humidity lag 5: ↓ вклад ~4 988 IDR (0.6%)
  • [External] Ветер: ↓ вклад ~4 849 IDR (0.6%)
  • [External] Температура (°C): ↓ вклад ~3 449 IDR (0.4%)
  • [External] rain lag 7: ↑ вклад ~3 422 IDR (0.4%)
  • [Operations] Среднее время приготовления (мин): ↑ вклад ~3 230 IDR (0.4%)
  • [External] rain lag 5: ↓ вклад ~2 950 IDR (0.4%)

📊 Вклад групп факторов:
  • Operations: 9.5%
  • Marketing: 78.6%
  • External: 11.9%

📅 Контекст дня:
  • 📱 GRAB оффлайн: 0:00:00
  • 🛵 GOJEK оффлайн: 0:00:00
  • 🎯 GRAB: spend 212 638 IDR, ROAS 7.02x
  • 🎯 GOJEK: spend 34 800 IDR, ROAS 15.80x
  • ⏱️ Приготовление: 22.88 мин
  • ⏳ Подтверждение: 0.00 мин
  • 🚗 Доставка: 24.57 мин
  • 🌧️ Дождь: 5.7 мм; 🌡️ Темп.: 27.6°C; 🌬️ Ветер: 17.5; 💧Влажность: 80.0
  • 🎌 Праздник: нет

🧠 Пояснение простыми словами:
  • Реклама GRAB отработала слабее обычного: ROAS 7.02x против среднего 13.84x (-49%).

  • Бюджет GRAB ниже среднего: 212 638 IDR vs 274 850 IDR (-23%).
  • На GOJEK отдача рекламы тоже слабее: ROAS 15.80x против 23.82x (-34%).
  • Бюджет GOJEK ниже среднего: 34 800 IDR vs 39 597 IDR (-12%).
  • Время приготовления 22.9 мин против среднего 16.6 мин (+38%).
  • Время подтверждения 0.0 мин против 0.0 мин (+0%).
  • Доставка 24.6 мин против 14.1 мин (+75%).
  • Оффлайн GRAB: 0:00:00 против среднего 0:10:01 (-100%).
  • Отмены GOJEK: 0 против среднего 0 (-100%).

🔮 What‑if (−10% SLA, +10% бюджет, без оффлайна): ожидаемый прирост ~-32 922 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-11 (выручка: 5 092 400 IDR; отклонение к медиане: -35.4%)

————————————————————————————————————————————————————————————————————————
🔎 Факторы, повлиявшие на результат (ML):
  • [Marketing] ROAS (GRAB): ↓ вклад ~360 580 IDR (54.6%)
  • [Marketing] Рекламный бюджет (GOJEK): ↓ вклад ~43 562 IDR (6.6%)
  • [Marketing] Рекламный бюджет (суммарно): ↑ вклад ~39 066 IDR (5.9%)
  • [Marketing] Рекламный бюджет (GRAB): ↑ вклад ~35 917 IDR (5.4%)
  • [Operations] Среднее время приготовления (мин): ↓ вклад ~21 247 IDR (3.2%)
  • [Operations] GOJEK: время приготовления: ↓ вклад ~19 947 IDR (3.0%)
  • [External] Влажность (%): ↓ вклад ~17 866 IDR (2.7%)
  • [Operations] GOJEK: время подтверждения: ↑ вклад ~16 319 IDR (2.5%)
  • [Operations] Среднее время подтверждения (мин): ↑ вклад ~10 029 IDR (1.5%)
  • [External] Дождь (мм): ↓ вклад ~7 706 IDR (1.2%)
  • [External] Выходной: ↓ вклад ~7 219 IDR (1.1%)
  • [Marketing] ROAS (GOJEK): ↑ вклад ~5 194 IDR (0.8%)
  • [Operations] Среднее время доставки (мин): ↑ вклад ~5 116 IDR (0.8%)
  • [Operations] GOJEK: время доставки: ↑ вклад ~4 944 IDR (0.7%)
  • [External] Ветер: ↓ вклад ~4 866 IDR (0.7%)
  • [External] rain lag 5: ↓ вклад ~4 785 IDR (0.7%)
  • [External] humidity lag 3: ↓ вклад ~4 085 IDR (0.6%)
  • [External] humidity lag 6: ↓ вклад ~3 904 IDR (0.6%)
  • [External] humidity lag 4: ↓ вклад ~3 895 IDR (0.6%)
  • [External] wind lag 3: ↓ вклад ~3 554 IDR (0.5%)
  • [External] humidity rolling mean 7: ↓ вклад ~3 297 IDR (0.5%)
  • [External] humidity lag 5: ↓ вклад ~3 297 IDR (0.5%)
  • [External] wind lag 7: ↓ вклад ~3 198 IDR (0.5%)

📊 Вклад групп факторов:
  • Operations: 12.1%
  • Marketing: 74.0%
  • External: 13.9%

📅 Контекст дня:
  • 📱 GRAB оффлайн: 0:00:00
  • 🛵 GOJEK оффлайн: 0:00:00
  • 🎯 GRAB: spend 260 856 IDR, ROAS 11.88x
  • 🎯 GOJEK: spend 36 000 IDR, ROAS 18.35x
  • ⏱️ Приготовление: 21.40 мин
  • ⏳ Подтверждение: 0.00 мин
  • 🚗 Доставка: 13.75 мин
  • 🌧️ Дождь: 1.3 мм; 🌡️ Темп.: 26.9°C; 🌬️ Ветер: 13.6; 💧Влажность: 87.0
  • 🎌 Праздник: нет

🧠 Пояснение простыми словами:
  • Реклама GRAB отработала слабее обычного: ROAS 11.88x против среднего 13.84x (-14%).

  • Бюджет GRAB ниже среднего: 260 856 IDR vs 274 850 IDR (-5%).
  • На GOJEK отдача рекламы тоже слабее: ROAS 18.35x против 23.82x (-23%).
  • Бюджет GOJEK ниже среднего: 36 000 IDR vs 39 597 IDR (-9%).
  • Время приготовления 21.4 мин против среднего 16.6 мин (+29%).
  • Время подтверждения 0.0 мин против 0.0 мин (+0%).
  • Доставка 13.8 мин против 14.1 мин (-2%).
  • Оффлайн GRAB: 0:00:00 против среднего 0:10:01 (-100%).
  • Отмены GOJEK: 0 против среднего 0 (-100%).

🔮 What‑if (−10% SLA, +10% бюджет, без оффлайна): ожидаемый прирост ~-1 018 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-04-21 (выручка: 1 793 000 IDR; отклонение к медиане: -77.2%)

————————————————————————————————————————————————————————————————————————
🔎 Факторы, повлиявшие на результат (ML):
  • [Marketing] ROAS (GRAB): ↓ вклад ~169 061 IDR (23.9%)
  • [Marketing] Рекламный бюджет (суммарно): ↓ вклад ~64 454 IDR (9.1%)
  • [Marketing] Рекламный бюджет (GOJEK): ↓ вклад ~61 683 IDR (8.7%)
  • [Marketing] ROAS (GOJEK): ↑ вклад ~41 381 IDR (5.8%)
  • [External] Дождь (мм): ↓ вклад ~38 189 IDR (5.4%)
  • [External] Ветер: ↓ вклад ~35 882 IDR (5.1%)
  • [External] Влажность (%): ↓ вклад ~29 835 IDR (4.2%)
  • [Operations] Среднее время подтверждения (мин): ↑ вклад ~29 425 IDR (4.2%)
  • [Marketing] Рекламный бюджет (GRAB): ↓ вклад ~28 082 IDR (4.0%)
  • [Operations] GOJEK: время подтверждения: ↑ вклад ~26 760 IDR (3.8%)
  • [External] Температура (°C): ↓ вклад ~16 845 IDR (2.4%)
  • [Marketing] Показы рекламы: ↓ вклад ~15 395 IDR (2.2%)
  • [External] humidity rolling mean 7: ↓ вклад ~15 019 IDR (2.1%)
  • [Operations] Среднее время приготовления (мин): ↑ вклад ~13 744 IDR (1.9%)
  • [Operations] GOJEK: время приготовления: ↑ вклад ~11 656 IDR (1.6%)
  • [External] wind lag 2: ↓ вклад ~11 452 IDR (1.6%)
  • [External] День недели: ↓ вклад ~10 320 IDR (1.5%)
  • [External] rain lag 3: ↓ вклад ~8 797 IDR (1.2%)
  • [External] rain lag 2: ↓ вклад ~8 657 IDR (1.2%)
  • [External] temp rolling mean 7: ↓ вклад ~7 378 IDR (1.0%)
  • [External] wind lag 7: ↓ вклад ~6 800 IDR (1.0%)
  • [External] wind lag 1: ↓ вклад ~5 446 IDR (0.8%)
  • [Operations] ops rating GOJEK: ↓ вклад ~5 288 IDR (0.7%)
  • [Marketing] mkt impressions GRAB: ↓ вклад ~4 110 IDR (0.6%)
  • [External] rain lag 5: ↓ вклад ~3 571 IDR (0.5%)
  • [External] rain lag 6: ↓ вклад ~3 490 IDR (0.5%)
  • [External] rain lag 7: ↓ вклад ~3 487 IDR (0.5%)

📊 Вклад групп факторов:
  • Operations: 13.0%
  • Marketing: 54.2%
  • External: 32.7%

📅 Контекст дня:
  • 📱 GRAB оффлайн: —
  • 🛵 GOJEK оффлайн: 0:00:00
  • 🎯 GOJEK: spend 27 600 IDR, ROAS 25.00x
  • ⏱️ Приготовление: 24.57 мин
  • ⏳ Подтверждение: 0.00 мин
  • 🚗 Доставка: 12.70 мин
  • 🌧️ Дождь: 0.9 мм; 🌡️ Темп.: 27.1°C; 🌬️ Ветер: 11.2; 💧Влажность: 79.0
  • 🎌 Праздник: нет

🧠 Пояснение простыми словами:
  • На GOJEK отдача рекламы тоже слабее: ROAS 25.00x против 23.82x (+5%).
  • Бюджет GOJEK ниже среднего: 27 600 IDR vs 39 597 IDR (-30%).
  • Время приготовления 24.6 мин против среднего 16.6 мин (+48%).
  • Время подтверждения 0.0 мин против 0.0 мин (+0%).
  • Доставка 12.7 мин против 14.1 мин (-10%).
  • Отмены GOJEK: 0 против среднего 0 (-100%).

🔮 What‑if (−10% SLA, +10% бюджет, без оффлайна): ожидаемый прирост ~-3 414 IDR

📉 КРИТИЧЕСКИЙ ДЕНЬ: 2025-05-15 (выручка: 5 446 000 IDR; отклонение к медиане: -30.9%)

————————————————————————————————————————————————————————————————————————
🔎 Факторы, повлиявшие на результат (ML):
  • [Marketing] ROAS (GRAB): ↓ вклад ~396 075 IDR (48.4%)
  • [Operations] Среднее время подтверждения (мин): ↓ вклад ~81 314 IDR (9.9%)
  • [Operations] GOJEK: время подтверждения: ↓ вклад ~67 401 IDR (8.2%)
  • [Marketing] Рекламный бюджет (GRAB): ↑ вклад ~51 427 IDR (6.3%)
  • [Marketing] Рекламный бюджет (суммарно): ↑ вклад ~40 547 IDR (5.0%)
  • [Marketing] Рекламный бюджет (GOJEK): ↓ вклад ~31 088 IDR (3.8%)
  • [External] Дождь (мм): ↓ вклад ~25 867 IDR (3.2%)
  • [Operations] Среднее время приготовления (мин): ↑ вклад ~14 814 IDR (1.8%)
  • [External] Ветер: ↓ вклад ~11 880 IDR (1.5%)
  • [External] Влажность (%): ↓ вклад ~10 541 IDR (1.3%)
  • [Operations] GOJEK: время приготовления: ↑ вклад ~9 258 IDR (1.1%)
  • [External] rain lag 5: ↓ вклад ~8 954 IDR (1.1%)
  • [External] День недели: ↑ вклад ~6 424 IDR (0.8%)
  • [External] rain lag 2: ↓ вклад ~4 854 IDR (0.6%)
  • [External] wind lag 6: ↓ вклад ~4 325 IDR (0.5%)
  • [External] rain lag 4: ↓ вклад ~4 251 IDR (0.5%)
  • [External] humidity lag 4: ↓ вклад ~3 582 IDR (0.4%)
  • [External] Температура (°C): ↓ вклад ~3 553 IDR (0.4%)
  • [External] temp lag 7: ↓ вклад ~2 965 IDR (0.4%)

📊 Вклад групп факторов:
  • Operations: 22.1%
  • Marketing: 63.9%
  • External: 14.0%

📅 Контекст дня:
  • 📱 GRAB оффлайн: 5:57:00
  • 🛵 GOJEK оффлайн: 0:00:00
  • 🎯 GRAB: spend 239 757 IDR, ROAS 11.07x
  • 🎯 GOJEK: spend 0 IDR, ROAS —x
  • ⏱️ Приготовление: — мин
  • ⏳ Подтверждение: — мин
  • 🚗 Доставка: — мин
  • 🌧️ Дождь: 6.2 мм; 🌡️ Темп.: 26.9°C; 🌬️ Ветер: 10.8; 💧Влажность: 88.0
  • 🎌 Праздник: нет

🧠 Пояснение простыми словами:
  • Реклама GRAB отработала слабее обычного: ROAS 11.07x против среднего 13.84x (-20%).

  • Бюджет GRAB ниже среднего: 239 757 IDR vs 274 850 IDR (-13%).
  • Бюджет GOJEK ниже среднего: 0 IDR vs 39 597 IDR (-100%).
  • Оффлайн GRAB: 5:57:00 против среднего 0:10:01 (+3466%).
  • Отмены GOJEK: 0 против среднего 0 (-100%).

🔮 What‑if (−10% SLA, +10% бюджет, без оффлайна): ожидаемый прирост ~17 367 IDR

Диагностика факторов за период:
  • 🌧️ Дождь (простая разница средних): 2.8%
  • 🎌 Праздники (простая разница средних): 0.0%

Источники: SQLite (grab_stats, gojek_stats), Open‑Meteo, Holidays cache

9. 🎯 СТРАТЕГИЧЕСКИЕ РЕКОМЕНДАЦИИ
————————————————————————————————————————————————————————————————————————
Приоритеты по факторам (ML):
  • [Marketing] ROAS (GRAB)
  • [Marketing] ROAS (GOJEK)
  • [Operations] Среднее время приготовления (мин)
  • [Marketing] Рекламный бюджет (суммарно)
  • [Operations] GOJEK: время приготовления
  • [Marketing] Рекламный бюджет (GRAB)
  • [Marketing] Рекламный бюджет (GOJEK)
  • [Operations] Среднее время подтверждения (мин)

Вклад групп факторов:
  • Operations: 28.1%
  • Marketing: 53.5%
  • External: 18.3%

Рекомендуемые действия:
  • Перераспределить бюджет в связки с лучшим ROAS; тест креативов и аудиторий; корректировка ставок

  • Погодные промо и бонусы курьерам в дождь; перенос активностей на «сухие» окна

  • Учитывать локальные праздники в планировании (снижение бюджета/акции на следующий день)

  • Контроль качества и рейтингов: работа с негативом, улучшение времени ожидания