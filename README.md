# ะะฝะฐะปะธัะธะบะฐ ะฟัะพะดะฐะถ ัะตััะพัะฐะฝะพะฒ (FastAPI + PostgreSQL + ETL + ML)

ะะพะดัะปัะฝะฐั ัะธััะตะผะฐ ะฐะฝะฐะปะธัะธะบะธ ะธ ะฟัะพะณะฝะพะทะฐ ะฟัะพะดะฐะถ ั FastAPI, PostgreSQL, ETL, ะธ ML (LightGBM + SHAP).

## ะัััััะน ััะฐัั (ะปะพะบะฐะปัะฝะพ)

ะขัะตะฑะพะฒะฐะฝะธั: Python 3.11+

1) ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
pip install -r requirements.txt
```

3) ะะฐะฟััะบ API

```bash
uvicorn app.main:app --reload
```

4) ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั (ะธะปะธ `DATABASE_URL`):

- `POSTGRES_HOST` (ะฟะพ ัะผะพะปัะฐะฝะธั: localhost)
- `POSTGRES_PORT` (ะฟะพ ัะผะพะปัะฐะฝะธั: 5432)
- `POSTGRES_DB` (ะฟะพ ัะผะพะปัะฐะฝะธั: analytics)
- `POSTGRES_USER` (ะฟะพ ัะผะพะปัะฐะฝะธั: postgres)
- `POSTGRES_PASSWORD` (ะฟะพ ัะผะพะปัะฐะฝะธั: postgres)

ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั:

```bash
python db/init_db.py
```

## ETL

- SQLite-ะธััะพัะฝะธะบ: `/workspace/database.sqlite`
- ะขััะฟะพัะพะบ (Excel): `/workspace/1.-Data-Kunjungan-2025-3.xls`, `/workspace/Table-1-7-Final-1-1.xls`
- Fake orders: ัะฐะนะป `/workspace/Fake orders` ัะพะดะตัะถะธั Google Sheet ัััะปะบั; ะปะธะฑะพ ะฟะตัะตะดะฐะนัะต `--fake-orders-sheet`.

ะกะฑะพัะบะฐ ะพะฑัะตะดะธะฝัะฝะฝะพะณะพ ะดะฐัะฐัะตัะฐ:

```bash
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv \
  --excel /workspace/1.-Data-Kunjungan-2025-3.xls /workspace/Table-1-7-Final-1-1.xls
```

ะะฐะฟะธัั ะฝะพัะผะฐะปะธะทะพะฒะฐะฝะฝัั ัะฐะฑะปะธั ะฒ PostgreSQL (ะฟัะพะดะฐะถะธ ะฟะพ ะฟะปะฐััะพัะผะฐะผ, ะพะฟะตัะฐัะธะพะฝะฝัะต, ะผะฐัะบะตัะธะฝะณ, ะฟะพะณะพะดะฐ, ะฟัะฐะทะดะฝะธะบะธ):

```bash
export POSTGRES_HOST=localhost
export POSTGRES_PORT=5432
export POSTGRES_DB=analytics
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=postgres

python etl/data_loader.py --run --write-postgres \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv
```

## ะะฑััะตะฝะธะต ML-ะผะพะดะตะปะธ ะธ ะพะฑัััะฝะธะผะพััั (SHAP)

```bash
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
```

- ะะพะดะตะปั: LightGBM (ัะตะณัะตััะธั ะฟะพ `total_sales`)
- ะััะตัะฐะบัั: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`

## API (ะฟะพัะปะต ETL ะธ ะพะฑััะตะฝะธั)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` โ ัะฒะพะดะฝัะน ะพัััั: ัะฐะบัะธัะตัะบะธะต/ะฟัะพะณะฝะพะทะฝัะต ะฟัะพะดะฐะถะธ, ััะตะดะฝะธะน ัะตะบ, ะขะะโัะฐะบัะพัั (SHAP)
- `GET /factors?period=...&restaurant_id=...` โ ัะฟะธัะพะบ ัะฐะบัะพัะพะฒ ั ะฒะปะธัะฝะธะตะผ ะฒ % (SHAP)
- ะัะต ะพัะฒะตัั โ ะฝะฐ ััััะบะพะผ

## ะะฐะทะฒััััะฒะฐะฝะธะต ะฝะฐ Replit

1) ะะผะฟะพััะธััะนัะต ัะตะฟะพะทะธัะพัะธะน ะฒ Replit.
2) ะ Secrets (Environment) ะทะฐะดะฐะนัะต ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ:
   - `GOOGLE_API_KEY` โ ะดะปั Google Sheets ั ัะตะนะบะพะฒัะผะธ ะทะฐะบะฐะทะฐะผะธ (ะตัะปะธ ะปะธัั ะฟัะธะฒะฐัะฝัะน โ ะพัะบัะพะนัะต ะดะปั ััะตะฝะธั ะฟะพ ัััะปะบะต)
   - `SQLITE_PATH` โ ะฟััั ะบ SQLite (ะฟะพ ัะผะพะปัะฐะฝะธั `/workspace/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` โ ะตัะปะธ ะธัะฟะพะปัะทัะตัะต ะฒะฝะตัะฝัั PostgreSQL
3) ะ `replit.nix` ะฝะต ััะตะฑัะตััั, ะฟัะพะตะบั ะฝะฐ Python โ Replit ัััะฐะฝะพะฒะธั ะทะฐะฒะธัะธะผะพััะธ ะธะท `requirements.txt` ะฐะฒัะพะผะฐัะธัะตัะบะธ.
4) ะะพะผะฐะฝะดะฐ ะทะฐะฟััะบะฐ (Run):
   - ะะตัะฒัะน ะทะฐะฟััะบ: ะฒัะฟะพะปะฝะธัั ETL ะธ ะพะฑััะตะฝะธะต (ะผะพะถะฝะพ ะฒ Shell ะธะปะธ Replit script)
     ```bash
     python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out /workspace/data/merged_dataset.csv
     python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
     ```
   - ะะฐัะตะผ ััะฐัั ัะตัะฒะตัะฐ:
     ```bash
     uvicorn app.main:app --host 0.0.0.0 --port 8000
     ```
5) ะัะพะฒะตัะบะฐ:
   - `GET /health` โ `{ "status": "ok" }`
   - `GET /report?period=2025-04-01_2025-05-31&restaurant_id=<ID>`
   - `GET /factors?period=2025-04-01_2025-05-31&restaurant_id=<ID>`

ะัะธะผะตัะฐะฝะธั ัะตััะฝะพััะธ ะดะฐะฝะฝัั:
- ะคะตะนะบะพะฒัะต ะทะฐะบะฐะทั ะฒััะธัะฐัััั ะธะท ะทะฐะบะฐะทะพะฒ ะธ ะฒััััะบะธ (Google Sheets ยซFake ordersยป)
- ะะพะณะพะดะฐ โ OpenโMeteo ะฟะพ ะณะตะพะปะพะบะฐัะธะธ ะบะฐะถะดะพะณะพ ัะตััะพัะฐะฝะฐ (ั ะบััะธัะพะฒะฐะฝะธะตะผ ะฒ SQLite)
- ะัะฐะทะดะฝะธะบะธ โ ะพัะธัะธะฐะปัะฝัะต (Nager.Date) + ะปะพะบะฐะปัะฝัะต ะฑะฐะปะธะนัะบะธะต (ัะบัะตะนะฟะธะฝะณ 2024/2025)
- ะขััะธััะธัะตัะบะธะน ะฟะพัะพะบ โ ะธะท ะฟัะตะดะพััะฐะฒะปะตะฝะฝัั Excel
- ะะพะดะตะปั ะพะฑััะฐะตััั ะฝะฐ ะฟะพะปะฝะพะผ ะฟะตัะธะพะดะต (2.5 ะณะพะดะฐ), ัะฐะบัะพัั โ ะฟะพ SHAP

## ะัะธะผะตั ะฟะพะดัะพะฑะฝะพะณะพ ะพััััะฐ (Ika Kero, ะฐะฟัะตะปัโะผะฐะน 2025, ะฑะตะท ML)

๐ 1. ะะกะะะะะะขะะะฌะะะ ะะะะฎะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ะะฑัะฐั ะฒััััะบะฐ: 462,089,600 IDR (GRAB: 156,945,600 IDR + GOJEK: 305,144,000 IDR)

๐ฆ ะะฑัะธะต ะทะฐะบะฐะทั: 1,183
   โโโ ๐ฑ GRAB: 339
   โโโ ๐ต GOJEK: 844

๐ 2. ะะะะะะ ะะะะะะ ะ ะขะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะธะฝะฐะผะธะบะฐ ะฟะพ ะผะตัััะฐะผ:
  2025-04: 225,734,600 IDR (30 ะดะฝะตะน, 7,524,487 IDR/ะดะตะฝั)
  2025-05: 236,355,000 IDR (31 ะดะฝะตะน, 7,624,355 IDR/ะดะตะฝั)

๐๏ธ ะััะพะดะฝัะต vs ะัะดะฝะธ:
  ๐ ะกัะตะดะฝะธะต ะฟัะพะดะฐะถะธ ะฒ ะฒััะพะดะฝัะต: 7,852,941 IDR
  ๐ ะกัะตะดะฝะธะต ะฟัะพะดะฐะถะธ ะฒ ะฑัะดะฝะธ: 7,467,945 IDR
  ๐ ะญััะตะบั ะฒััะพะดะฝัั: 5.2%
๐ ะะะะะะ ะะะะะงะะฅ ะะะะ:
๐ ะัััะธะน ะดะตะฝั: 2025-04-21 - 16,147,900 IDR
   ๐ฐ GRAB: 6,315,500 IDR (6 ะทะฐะบะฐะทะพะฒ) | GOJEK: 9,832,400 IDR (27 ะทะฐะบะฐะทะพะฒ)
๐ ะฅัะดัะธะน ะดะตะฝั: 2025-05-02 - 2,987,100 IDR
   ๐ฐ GRAB: 769,700 IDR | GOJEK: 2,217,400 IDR

๐ 4. ะะะะะะขะะะะะะะฏ ะญะคะคะะะขะะะะะกะขะฌ ะ ะะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะฐัะบะตัะธะฝะณะพะฒะฐั ะฒะพัะพะฝะบะฐ (ัะพะปัะบะพ GRAB):
  ๐๏ธ ะะพะบะฐะทั ัะตะบะปะฐะผั: 60,656
  ๐ ะะพัะตัะตะฝะธั ะผะตะฝั: 2,294 (CTR: 3.8%)
  ๐ ะะพะฑะฐะฒะปะตะฝะธั ะฒ ะบะพัะทะธะฝั: 436 (ะบะพะฝะฒะตััะธั: 8.4% ะพั ะบะปะธะบะพะฒ)
  ๐ฆ ะะฐะบะฐะทั ะพั ัะตะบะปะฐะผั: 193 (ะบะพะฝะฒะตััะธั: 44.3% ะพั ะบะพัะทะธะฝั)
  
  ๐ ะะะฎะงะะะซะ ะะะะะะะกะะ:
  โข ๐ฏ ะะพะบะฐะท โ ะะฐะบะฐะท: 0.3%
  โข ๐ ะะปะธะบ โ ะะฐะบะฐะท: 8.4%
  โข ๐ ะะพัะทะธะฝะฐ โ ะะฐะบะฐะท: 44.3%
  
  ๐ ะะะขะะะฌะะซะ ะะะะะะ ะะะะะะะ:
  โข ๐ ะะพะปั ััะตะดัะธั ะฑะตะท ะฟะพะบัะฟะบะธ: 81.0% (1,858 ััะปะธ ะฑะตะท ะฟะพะบัะฟะบะธ)
  โข ๐ ะะพะปั ะฝะตะพัะพัะผะปะตะฝะฝัั ะบะพัะทะธะฝ: 55.7% (243 ะดะพะฑะฐะฒะธะปะธ, ะฝะพ ะฝะต ะบัะฟะธะปะธ)
  
  ๐ฐ ะะะขะะะฆะะะ ะะะขะะะะะะฆะะ ะะะะะะะ:
  โข ๐ ะกะฝะธะถะตะฝะธะต ะดะพะปะธ ััะตะดัะธั ะฝะฐ 10%: 44,446,002 IDR
  โข ๐ ะฃัััะฐะฝะตะฝะธะต ะฝะตะพัะพัะผะปะตะฝะฝัั ะบะพัะทะธะฝ: 131,317,452 IDR  
  โข ๐ฏ ะะฑัะธะน ะฟะพัะตะฝัะธะฐะป: 175,763,454 IDR

๐ธ ะกัะพะธะผะพััั ะฟัะธะฒะปะตัะตะฝะธั (GRAB):
  ๐ฐ CPC: 1,879 IDR (ัะฐัััั: ะฑัะดะถะตั รท ะฟะพัะตัะตะฝะธั ะผะตะฝั)
  ๐ฐ CPA: 22,333 IDR (ัะฐัััั: ะฑัะดะถะตั รท ะทะฐะบะฐะทั ะพั ัะตะบะปะฐะผั)

7. โญ ะะะงะะกะขะะ ะะะกะะฃะะะะะะะฏ ะ ะฃะะะะะะขะะะะะะะะกะขะฌ (GOJEK)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ะะฐัะฟัะตะดะตะปะตะฝะธะต ะพัะตะฝะพะบ (ะฒัะตะณะพ: 95):
  โญโญโญโญโญ 5 ะทะฒะตะทะด: 92 (96.8%)
  โญโญโญโญ 4 ะทะฒะตะทะดั: 0 (0.0%)
  โญโญโญ 3 ะทะฒะตะทะดั: 2 (2.1%)
  โญโญ 2 ะทะฒะตะทะดั: 1 (1.1%)
  โญ 1 ะทะฒะตะทะดะฐ: 0 (0.0%)

๐ ะะฝะดะตะบั ัะดะพะฒะปะตัะฒะพัะตะฝะฝะพััะธ: 4.93/5.0
๐จ ะะตะณะฐัะธะฒะฝัะต ะพัะทัะฒั (1-2โ): 1 (1.1%)

๐ ะงะฐััะพัะฐ ะฟะปะพัะธั ะพัะตะฝะพะบ (ะฝะต 5โ):
  ๐ ะะปะพัะธั ะพัะตะฝะพะบ ะฒัะตะณะพ: 3 ะธะท 95 (3.2%)
  ๐ฆ ะฃัะฟะตัะฝัั ะทะฐะบะฐะทะพะฒ GOJEK ะฝะฐ 1 ะฟะปะพััั ะพัะตะฝะบั: 247.7

ะัะธะผะตัะฐะฝะธะต: ะัะธะผะตั ะฑะตะท MLโัะฐะทะดะตะปะฐ. ะะพัะปะต ะพะฑััะตะฝะธั ะผะพะดะตะปะธ ะฒ ะพัััั ะดะพะฑะฐะฒัััั: ะฟัะพะณะฝะพะท vs ัะฐะบั, ะขะะโัะฐะบัะพัั (SHAP), ะฐะฝะพะผะฐะปะธะธ, ััะฐะฒะฝะตะฝะธะต ะฟะตัะธะพะดะพะฒ.