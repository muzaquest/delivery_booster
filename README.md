# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (FastAPI + PostgreSQL + ETL + ML)

–ú–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø—Ä–æ–¥–∞–∂ —Å FastAPI, PostgreSQL, ETL, –∏ ML (LightGBM/RandomForest + SHAP).

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: Python 3.11+

1) –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
python3 -m venv .venv
source .venv/bin/activate
```

2) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

3) –ó–∞–ø—É—Å–∫ API

```bash
uvicorn app.main:app --reload
```

4) –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è

```bash
curl http://127.0.0.1:8000/health
# {"status": "ok"}
```

## PostgreSQL

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–ª–∏ `DATABASE_URL`):

- `POSTGRES_HOST` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: localhost)
- `POSTGRES_PORT` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5432)
- `POSTGRES_DB` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: analytics)
- `POSTGRES_USER` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: postgres)
- `POSTGRES_PASSWORD` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: postgres)

–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:

```bash
python db/init_db.py
```

## ETL

- SQLite-–∏—Å—Ç–æ—á–Ω–∏–∫: `/workspace/database.sqlite`
- –¢—É—Ä–ø–æ—Ç–æ–∫ (Excel): `/workspace/1.-Data-Kunjungan-2025-3.xls`, `/workspace/Table-1-7-Final-1-1.xls`
- Fake orders: —Ñ–∞–π–ª `/workspace/Fake orders` —Å–æ–¥–µ—Ä–∂–∏—Ç Google Sheet —Å—Å—ã–ª–∫—É; –ª–∏–±–æ –ø–µ—Ä–µ–¥–∞–π—Ç–µ `--fake-orders-sheet`.

–°–±–æ—Ä–∫–∞ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞:

```bash
python etl/data_loader.py --run \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv \
  --excel /workspace/1.-Data-Kunjungan-2025-3.xls /workspace/Table-1-7-Final-1-1.xls
```

–ó–∞–ø–∏—Å—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –≤ PostgreSQL (–ø—Ä–æ–¥–∞–∂–∏ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ø–æ–≥–æ–¥–∞, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏):

```bash
export POSTGRES_HOST=localhost
export POSTGRES_PORT=5432
export POSTGRES_DB=analytics
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=postgres

python etl/data_loader.py --run --write-postgres \
  --start 2023-01-01 --end 2025-12-31 \
  --out /workspace/data/merged_dataset.csv
```

## –û–±—É—á–µ–Ω–∏–µ ML-–º–æ–¥–µ–ª–∏ –∏ –æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å (SHAP)

```bash
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
```

- –ú–æ–¥–µ–ª–∏: LightGBM –∏ RandomForest (–≤—ã–±–∏—Ä–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞ –ø–æ MAE)
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: `ml/artifacts/model.joblib`, `features.json`, `shap_background.csv`, `metrics.json`

## API (–ø–æ—Å–ª–µ ETL –∏ –æ–±—É—á–µ–Ω–∏—è)

- `GET /report?period=YYYY-MM-DD_YYYY-MM-DD&restaurant_id=...` ‚Äî —Å–≤–æ–¥–∫–∞: —Ñ–∞–∫—Ç/–ø—Ä–æ–≥–Ω–æ–∑, AOV, –¢–û–ü‚Äë—Ñ–∞–∫—Ç–æ—Ä—ã (SHAP)
- `GET /factors?period=...&restaurant_id=...` ‚Äî —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Å –≤–ª–∏—è–Ω–∏–µ–º –≤ % (SHAP)
- `GET /report-text?period=...&restaurant_id=...` ‚Äî –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º (—Å–æ –≤—Å–µ–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ ML)

## –†–∞–∑–¥–µ–ª ‚Äú–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–Ω–∏ (ML)‚Äù

–í —Ç–µ–∫—Å—Ç–æ–≤–æ–º –æ—Ç—á—ë—Ç–µ (`/report-text`) –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –¥–Ω–∏ —Å –ø–∞–¥–µ–Ω–∏–µ–º –ø—Ä–æ–¥–∞–∂ ‚â• 30% –∫ –º–µ–¥–∏–∞–Ω–µ –ø–µ—Ä–∏–æ–¥–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è:
- –¢–û–ü‚Äë—Ñ–∞–∫—Ç–æ—Ä—ã (SHAP) –ø–æ –≤—Å–µ–º –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º: –∫–∞—Ç–µ–≥–æ—Ä–∏—è (Operations/Marketing/External/Quality/Other), –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (‚Üë/‚Üì), –≤–∫–ª–∞–¥ –≤ IDR –∏ %
- –í–∫–ª–∞–¥ –≥—Ä—É–ø–ø —Ñ–∞–∫—Ç–æ—Ä–æ–≤ (%): Operations, Marketing, External (–ø–æ–≥–æ–¥–∞/–ø—Ä–∞–∑–¥–Ω–∏–∫–∏/—Ç—É—Ä–ø–æ—Ç–æ–∫), Quality
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–Ω—è: –æ—Ñ—Ñ–ª–∞–π–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º (GRAB/GOJEK) —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, –ø–æ–≥–æ–¥–∞ (–¥–æ–∂–¥—å –º–º, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≤–µ—Ç–µ—Ä, –≤–ª–∞–∂–Ω–æ—Å—Ç—å), —Ñ–ª–∞–≥ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞, –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ (spend/ROAS), –æ–ø–µ—Ä–∞—Ü–∏–∏ (prep/accept/delivery)
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –Ω–∏–≤–µ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –ø–∞–¥–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (Only Eggs, –∞–ø—Ä–µ–ª—å‚Äì–º–∞–π 2025):

```bash
curl "http://127.0.0.1:8000/report-text?period=2025-04-01_2025-05-31&restaurant_id=20"
```

–§—Ä–∞–≥–º–µ–Ω—Ç —Ä–∞–∑–¥–µ–ª–∞:

```
8. üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –î–ù–ò (ML)
‚Äî
üìâ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ù–¨: 2025-04-21 (–≤—ã—Ä—É—á–∫–∞: 1 793 000 IDR; –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∫ –º–µ–¥–∏–∞–Ω–µ: ‚àí77.2%)
üîé –¢–û–ü‚Äë—Ñ–∞–∫—Ç–æ—Ä—ã (ML):
  ‚Ä¢ [Marketing] mkt_roas_grab: ‚Üì –≤–∫–ª–∞–¥ ~169 061 IDR (X%)
  ‚Ä¢ [Operations] preparation_time_mean: ‚Üì –≤–∫–ª–∞–¥ ~233 904 IDR (Y%)
  ...
üìä –í–∫–ª–∞–¥ –≥—Ä—É–ø–ø —Ñ–∞–∫—Ç–æ—Ä–æ–≤: Operations 45.0%, Marketing 38.0%, External 10.0%...
üìÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–Ω—è:
  ‚Ä¢ üì± GRAB –æ—Ñ—Ñ–ª–∞–π–Ω: 0:00:00
  ‚Ä¢ üõµ GOJEK –æ—Ñ—Ñ–ª–∞–π–Ω: 1:10:00
  ‚Ä¢ üéØ ROAS –∏ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞–Ω–∞–ª–∞–º, SLA, –ø–æ–≥–æ–¥–∞, –ø—Ä–∞–∑–¥–Ω–∏–∫
üí° –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  ‚Ä¢ –ü–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ –∏ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å SLA –≤ –ø–∏–∫–µ; –ø–æ–≥–æ–¥–Ω—ã–µ –ø—Ä–æ–º–æ –≤ –¥–æ–∂–¥—å
```

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Replit

1) –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ Replit.
2) –í Secrets (Environment) –∑–∞–¥–∞–π—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
   - `GOOGLE_API_KEY` ‚Äî –¥–ª—è Google Sheets —Å —Ñ–µ–π–∫–æ–≤—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏
   - `SQLITE_PATH` ‚Äî –ø—É—Ç—å –∫ SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/workspace/database.sqlite`)
   - `DATABASE_URL`/`POSTGRES_*` ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–Ω–µ—à–Ω—é—é PostgreSQL
3) –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: –≤—ã–ø–æ–ª–Ω–∏—Ç–µ ETL –∏ –æ–±—É—á–µ–Ω–∏–µ, –∑–∞—Ç–µ–º —Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞:

```bash
python etl/data_loader.py --run --start 2023-01-01 --end 2025-12-31 --out /workspace/data/merged_dataset.csv
python ml/training.py --csv /workspace/data/merged_dataset.csv --out /workspace/ml/artifacts
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –§–µ–π–∫–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –≤—ã—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –∑–∞–∫–∞–∑–æ–≤ –∏ –≤—ã—Ä—É—á–∫–∏
- –ü–æ–≥–æ–¥–∞ ‚Äî Open‚ÄëMeteo –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (–∫—ç—à –≤ SQLite; —Ñ–æ–ª–±—ç–∫ –ø–æ –≥–µ–æ–∫–æ–¥–∏–Ω–≥—É)
- –ü—Ä–∞–∑–¥–Ω–∏–∫–∏ ‚Äî Nager.Date + –ª–æ–∫–∞–ª—å–Ω—ã–µ –±–∞–ª–∏–π—Å–∫–∏–µ (—Å–∫—Ä–µ–π–ø–∏–Ω–≥ 2024/2025; –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ‚Äî –∫–µ—à)
- –¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ ‚Äî –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö Excel
- –ú–æ–¥–µ–ª—å –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –≤—Å—ë–º –ø–µ—Ä–∏–æ–¥–µ (2.5 –≥–æ–¥–∞), —Ñ–∞–∫—Ç–æ—Ä—ã ‚Äî SHAP; —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π